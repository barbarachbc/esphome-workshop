---
interface Props {
  headings: Array<{
    depth: number;
    slug: string;
    text: string;
  }>;
  minDepth?: number; // Minimum heading depth to include (default: 2)
  maxDepth?: number; // Maximum heading depth to include (default: 4)
}

const { headings, minDepth = 2, maxDepth = 4 } = Astro.props;

// Filter headings based on depth range
const tocHeadings = headings.filter(h => h.depth >= minDepth && h.depth <= maxDepth);
---

<nav class="bg-white border border-gray-200 rounded-lg p-6 md:mb-0 mb-8" aria-label="Table of Contents">
  <details class="toc-container" open>
    <summary class="flex justify-between items-center cursor-pointer list-none mb-4 md:pointer-events-none md:py-0 py-2 [&::-webkit-details-marker]:hidden [&:not([open])]:mb-0 md:[&:not([open])]:mb-4">
      <h2 class="m-0 text-xl text-gray-800 font-semibold">On This Page</h2>
      <span class="toc-toggle-icon text-gray-500 text-sm transition-transform duration-200 md:hidden" aria-hidden="true">â–¼</span>
    </summary>
    <ul class="list-none p-0 m-0">
      {tocHeadings.map((heading) => (
        <li class={`mb-2 ${
          heading.depth === 1 ? 'pl-0 font-semibold' :
          heading.depth === 2 ? 'pl-0' :
          heading.depth === 3 ? 'pl-4' :
          'pl-8'
        }`}>
          <a href={`#${heading.slug}`} class="toc-link block text-gray-500 no-underline py-1 px-2 rounded transition-all duration-200 text-[0.9375rem] leading-6 hover:text-blue-600 hover:underline hover:bg-blue-50 focus:outline-2 focus:outline-blue-600 focus:outline-offset-2">
            {heading.text}
          </a>
        </li>
      ))}
    </ul>
  </details>
</nav>

<style>
  /* Active state styling - uses dynamic class toggling from script */
  .toc-link.active {
    color: #2563eb;
    font-weight: 600;
    border-left: 3px solid #2563eb;
    padding-left: calc(0.5rem - 3px);
    background: #eff6ff;
  }

  /* Toggle icon rotation when details is open */
  .toc-container[open] .toc-toggle-icon {
    transform: rotate(180deg);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tocLinks = document.querySelectorAll('.toc-link');
    
    // Function to update active link based on hash
    function updateActiveLink(hash: string) {
      tocLinks.forEach(link => {
        link.classList.remove('active');
        const href = link.getAttribute('href');
        if (href === hash) {
          link.classList.add('active');
        }
      });
    }

    // Update on page load
    if (window.location.hash) {
      updateActiveLink(window.location.hash);
    }

    // Update when hash changes (clicking ToC links or browser back/forward)
    window.addEventListener('hashchange', () => {
      updateActiveLink(window.location.hash);
    });

    // Build a map of sections that actually exist in the DOM
    const sectionMap = new Map();
    tocLinks.forEach(link => {
      const href = link.getAttribute('href');
      if (href) {
        const section = document.querySelector(href);
        if (section) {
          sectionMap.set(href, { link, section });
        }
      }
    });

    if (sectionMap.size === 0) return;

    const observerOptions = {
      rootMargin: '-20% 0px -60% 0px',
      threshold: 0
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const id = entry.target.getAttribute('id');
          const targetHref = `#${id}`;
          
          // Only update if we're not navigating via hash (to avoid conflicts)
          if (!window.location.hash || window.location.hash === targetHref) {
            updateActiveLink(targetHref);
            
            // Update URL hash without scrolling
            if (history.replaceState) {
              history.replaceState(null, '', targetHref);
            }
          }
        }
      });
    }, observerOptions);

    // Observe all sections
    sectionMap.forEach(({ section }) => {
      observer.observe(section);
    });

    // Auto-collapse ToC on mobile after clicking a link
    const isMobile = () => window.innerWidth < 769;
    
    tocLinks.forEach(link => {
      link.addEventListener('click', () => {
        if (isMobile()) {
          const details = document.querySelector('.toc-container');
          if (details instanceof HTMLDetailsElement) {
            // Small delay to allow smooth scroll to start
            setTimeout(() => {
              details.open = false;
            }, 100);
          }
        }
      });
    });
  });
</script>
