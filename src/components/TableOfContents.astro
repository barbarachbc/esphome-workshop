---
interface Props {
  headings: Array<{
    depth: number;
    slug: string;
    text: string;
  }>;
  minDepth?: number; // Minimum heading depth to include (default: 2)
  maxDepth?: number; // Maximum heading depth to include (default: 4)
}

const { headings, minDepth = 2, maxDepth = 4 } = Astro.props;

// Filter headings based on depth range
const tocHeadings = headings.filter(h => h.depth >= minDepth && h.depth <= maxDepth);

// Group headings by H2 (or H1 if included) sections for collapsible functionality
interface HeadingSection {
  heading: { depth: number; slug: string; text: string };
  children: Array<{ depth: number; slug: string; text: string }>;
}

const headingSections: HeadingSection[] = [];
let currentSection: HeadingSection | null = null;

tocHeadings.forEach(heading => {
  if (heading.depth === 1 || heading.depth === 2) {
    // Start new section
    currentSection = { heading, children: [] };
    headingSections.push(currentSection);
  } else if (currentSection && heading.depth > currentSection.heading.depth) {
    // Add to current section
    currentSection.children.push(heading);
  }
});

// Only enable collapsible sections if there are 3+ sections with children
const enableCollapsible = headingSections.filter(s => s.children.length > 0).length >= 3;
---

<nav class="rounded-lg p-6 md:mb-0 mb-8" style="background: var(--bg-card); border: 1px solid var(--border-card);" aria-label="Table of Contents">
  <details class="toc-container" open>
    <summary class="flex justify-between items-center cursor-pointer list-none mb-4 md:pointer-events-none md:py-0 py-2 [&::-webkit-details-marker]:hidden [&:not([open])]:mb-0 md:[&:not([open])]:mb-4">
      <h2 class="m-0 text-xl font-semibold" style="color: var(--text-heading);">On This Page</h2>
      <svg class="toc-toggle-icon w-5 h-5 transition-transform duration-200 md:hidden" style="color: var(--text-secondary);" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
      </svg>
    </summary>
    
    {enableCollapsible ? (
      <ul class="list-none p-0 m-0">
        {headingSections.map((section, index) => (
          section.children.length > 0 ? (
            <li class="mb-2">
              <details class="toc-section" open={index === 0} data-slug={section.heading.slug}>
                <summary class="flex items-center gap-1 py-1 px-2 rounded transition-colors list-none [&::-webkit-details-marker]:hidden" onmouseover="this.style.background='var(--bg-secondary)';" onmouseout="this.style.background='transparent';">
                  <svg class="toc-section-icon w-3 h-3 transition-transform duration-200 shrink-0" style="color: var(--text-secondary);" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7" />
                  </svg>
                  <a href={`#${section.heading.slug}`} class="toc-link toc-section-link flex-1 no-underline font-medium text-[0.9375rem] leading-6" style="color: var(--text-secondary);" onmouseover="this.style.color='var(--text-link)';" onmouseout="this.style.color='var(--text-secondary)';">
                    {section.heading.text}
                  </a>
                </summary>
                <ul class="list-none pl-4 mt-1">
                  {section.children.map(child => (
                    <li class={`mb-1 ${child.depth === 3 ? 'pl-0' : 'pl-4'}`}>
                      <a href={`#${child.slug}`} class="toc-link block no-underline py-1 px-2 rounded transition-all duration-200 text-[0.9375rem] leading-6 hover:underline" style="color: var(--text-secondary);" onmouseover="this.style.color='var(--text-link)'; this.style.background='var(--bg-secondary)';" onmouseout="this.style.color='var(--text-secondary)'; this.style.background='transparent';">
                        {child.text}
                      </a>
                    </li>
                  ))}
                </ul>
              </details>
            </li>
          ) : (
            <li class="mb-2">
              <a href={`#${section.heading.slug}`} class="toc-link block no-underline py-1 px-2 rounded transition-all duration-200 text-[0.9375rem] leading-6 hover:underline" style="color: var(--text-secondary);" onmouseover="this.style.color='var(--text-link)'; this.style.background='var(--bg-secondary)';" onmouseout="this.style.color='var(--text-secondary)'; this.style.background='transparent';">
                {section.heading.text}
              </a>
            </li>
          )
        ))}
      </ul>
    ) : (
      <ul class="list-none p-0 m-0">
        {tocHeadings.map((heading) => (
          <li class={`mb-2 ${
            heading.depth === 1 ? 'pl-0 font-semibold' :
            heading.depth === 2 ? 'pl-0' :
            heading.depth === 3 ? 'pl-4' :
            'pl-8'
          }`}>
            <a href={`#${heading.slug}`} class="toc-link block no-underline py-1 px-2 rounded transition-all duration-200 text-[0.9375rem] leading-6 hover:underline focus:outline-2 focus:outline-offset-2" style="color: var(--text-secondary); outline-color: var(--accent-blue);" onmouseover="this.style.color='var(--text-link)'; this.style.background='var(--bg-secondary)';" onmouseout="this.style.color='var(--text-secondary)'; this.style.background='transparent';">
              {heading.text}
            </a>
          </li>
        ))}
      </ul>
    )}
    
  </details>
</nav>

<style>
  /* Active state styling - uses dynamic class toggling from script */
  .toc-link.active {
    color: var(--accent-blue);
    font-weight: 600;
    border-left: 3px solid var(--accent-blue);
    padding-left: calc(0.5rem - 3px);
    background: var(--accent-blue-light);
  }

  /* Toggle icon rotation when details is open */
  .toc-container[open] .toc-toggle-icon {
    transform: rotate(180deg);
  }

  /* Collapsible section styling */
  .toc-section[open] > summary > .toc-section-icon {
    transform: rotate(90deg);
  }

  /* Floating back to top button - show when scrolled */
  #back-to-top {
    opacity: 0;
    pointer-events: none;
    will-change: opacity;
    background: var(--accent-blue);
  }
  
  #back-to-top:hover {
    background: var(--accent-blue-dark);
  }

  #back-to-top.visible {
    opacity: 1;
    pointer-events: auto;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Get or create back-to-top button
    let backToTopButton = document.getElementById('back-to-top');
    
    if (!backToTopButton) {
      // Create and append floating back-to-top button to body
      backToTopButton = document.createElement('button');
      backToTopButton.id = 'back-to-top';
      backToTopButton.setAttribute('aria-label', 'Back to top');
      backToTopButton.className = 'fixed bottom-8 right-8 p-3 text-white rounded-full shadow-lg transition-opacity duration-300 focus:outline-2 focus:outline-offset-2';
      backToTopButton.style.zIndex = '9999';
      backToTopButton.style.opacity = '0';
      backToTopButton.style.pointerEvents = 'none';
      backToTopButton.style.transition = 'opacity 300ms ease-in-out';
      backToTopButton.style.background = 'var(--accent-blue)';
      backToTopButton.innerHTML = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
        </svg>
      `;
      document.body.appendChild(backToTopButton);
    }

    const tocLinks = document.querySelectorAll('.toc-link');
    
    // Function to update active link based on hash
    // @ts-expect-error - hash is a string
    function updateActiveLink(hash) {
      tocLinks.forEach(link => {
        link.classList.remove('active');
        const href = link.getAttribute('href');
        if (href === hash) {
          link.classList.add('active');
        }
      });
    }

    // Update on page load
    if (window.location.hash) {
      updateActiveLink(window.location.hash);
    }

    // Update when hash changes (clicking ToC links or browser back/forward)
    window.addEventListener('hashchange', () => {
      updateActiveLink(window.location.hash);
    });

    // Build a map of sections that actually exist in the DOM
    const sectionMap = new Map();
    tocLinks.forEach(link => {
      const href = link.getAttribute('href');
      if (href) {
        //querySelector fails for #3d.... leading digit, so let's fix it
        const patchForLeadingDigit = !isNaN(Number(href[1]));
        //if href starts with a digit, it requires that digit is unicode escaped
        const section = document.querySelector(!patchForLeadingDigit ? href : ('#\\3'+href.substring(1)));
        if (section) {
          sectionMap.set(href, { link, section });
        }
      }
    });

    if (sectionMap.size > 0) {
      const observerOptions = {
        rootMargin: '-20% 0px -60% 0px',
        threshold: 0
      };

      const observer = new IntersectionObserver((entries) => {
        if (!allowHashUpdate) return;
        
        // Only use entries that are intersecting, and pick the first one
        const intersectingEntries = entries.filter(e => e.isIntersecting);
        if (intersectingEntries.length === 0) return;
        
        // Sort by their position to pick the topmost one
        const topmost = intersectingEntries.sort((a, b) => 
          a.boundingClientRect.top - b.boundingClientRect.top
        )[0];
        
        const id = topmost.target.getAttribute('id');
        const targetHref = `#${id}`;
        
        // Always update active link, but only update hash if it's not already correct
        updateActiveLink(targetHref);
        
        if (history.replaceState && window.location.hash !== targetHref) {
          history.replaceState(null, '', targetHref);
        }
      }, observerOptions);

      // Observe all sections
      sectionMap.forEach(({ section }) => {
        observer.observe(section);
      });
    }

    // Auto-collapse ToC on mobile after clicking a link
    const isMobile = () => window.innerWidth < 769;
    
    // Flag to prevent observer from updating hash when user clears it
    let allowHashUpdate = true;
    
    tocLinks.forEach(link => {
      link.addEventListener('click', () => {
        if (isMobile()) {
          const details = document.querySelector('.toc-container');
          if (details instanceof HTMLDetailsElement) {
            // Small delay to allow smooth scroll to start
            setTimeout(() => {
              details.open = false;
            }, 100);
          }
        }
      });
    });

    // Back to Top button functionality
    if (backToTopButton) {
      // Show/hide button based on scroll position
      const toggleBackToTopButton = () => {
        if (window.scrollY > 300) {
          backToTopButton.style.opacity = '1';
          backToTopButton.style.pointerEvents = 'auto';
        } else {
          backToTopButton.style.opacity = '0';
          backToTopButton.style.pointerEvents = 'none';
        }
      };

      // Check on page load
      toggleBackToTopButton();

      // Check on scroll - call directly (passive event, minimal perf impact)
      window.addEventListener('scroll', toggleBackToTopButton, { passive: true });

      backToTopButton.addEventListener('click', () => {
        // Prevent observer from setting hash during scroll
        allowHashUpdate = false;
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        // Remove active state from all ToC links
        tocLinks.forEach(link => {
          link.classList.remove('active');
        });
        
        // Update URL to remove hash
        if (history.replaceState) {
          history.replaceState(null, '', window.location.pathname);
        }

        // Move focus to top of page for accessibility
        const main = document.querySelector('main') || document.querySelector('article') || document.body;
        main.focus({ preventScroll: true });

        // Close ToC on mobile when back-to-top is clicked
        if (isMobile()) {
          const details = document.querySelector('.toc-container');
          if (details instanceof HTMLDetailsElement) {
            details.open = false;
          }
        }
        
        // Re-enable hash updates after scroll completes
        setTimeout(() => {
          allowHashUpdate = true;
        }, 500);
      });
    }

    // Handle click on collapsible section links - expand section and navigate
    const sectionLinks = document.querySelectorAll('.toc-section-link');
    sectionLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        // Find the parent details element
        const details = link.closest('.toc-section');
        if (details instanceof HTMLDetailsElement) {
          // Expand the section if it's collapsed
          if (!details.open) {
            e.preventDefault();
            details.open = true;
            // Allow the DOM to update, then navigate
            setTimeout(() => {
              window.location.hash = link.getAttribute('href') || '';
            }, 10);
          }
          // If already open, let the default navigation happen
        }
      });
    });
  });
</script>
