---
interface Props {
  headings: Array<{
    depth: number;
    slug: string;
    text: string;
  }>;
  minDepth?: number; // Minimum heading depth to include (default: 2)
  maxDepth?: number; // Maximum heading depth to include (default: 4)
}

const { headings, minDepth = 2, maxDepth = 4 } = Astro.props;

// Filter headings based on depth range
const tocHeadings = headings.filter(h => h.depth >= minDepth && h.depth <= maxDepth);

// Group headings by H2 (or H1 if included) sections for collapsible functionality
interface HeadingSection {
  heading: { depth: number; slug: string; text: string };
  children: Array<{ depth: number; slug: string; text: string }>;
}

const headingSections: HeadingSection[] = [];
let currentSection: HeadingSection | null = null;

tocHeadings.forEach(heading => {
  if (heading.depth === 1 || heading.depth === 2) {
    // Start new section
    currentSection = { heading, children: [] };
    headingSections.push(currentSection);
  } else if (currentSection && heading.depth > currentSection.heading.depth) {
    // Add to current section
    currentSection.children.push(heading);
  }
});

// Only enable collapsible sections if there are 3+ sections with children
const enableCollapsible = headingSections.filter(s => s.children.length > 0).length >= 3;
---

<nav class="bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-lg p-6 md:mb-0 mb-8" aria-label="Table of Contents">
  <details class="toc-container" open>
    <summary class="flex justify-between items-center cursor-pointer list-none mb-4 md:pointer-events-none md:py-0 py-2 [&::-webkit-details-marker]:hidden [&:not([open])]:mb-0 md:[&:not([open])]:mb-4">
      <h2 class="m-0 text-xl text-gray-800 dark:text-slate-100 font-semibold">On This Page</h2>
      <span class="toc-toggle-icon text-gray-500 dark:text-slate-400 text-sm transition-transform duration-200 md:hidden" aria-hidden="true">▼</span>
    </summary>
    
    {enableCollapsible ? (
      <ul class="list-none p-0 m-0">
        {headingSections.map((section, index) => (
          section.children.length > 0 ? (
            <li class="mb-2">
              <details class="toc-section" open={index === 0}>
                <summary class="flex items-center gap-1 cursor-pointer py-1 px-2 rounded transition-colors hover:bg-blue-50 dark:hover:bg-slate-700/50 list-none [&::-webkit-details-marker]:hidden">
                  <span class="text-xs text-gray-500 dark:text-slate-400 transition-transform duration-200 inline-block" aria-hidden="true">▶</span>
                  <a href={`#${section.heading.slug}`} class="toc-link flex-1 text-gray-700 dark:text-slate-300 no-underline font-medium text-[0.9375rem] leading-6 hover:text-blue-600 dark:hover:text-blue-400">
                    {section.heading.text}
                  </a>
                </summary>
                <ul class="list-none pl-4 mt-1">
                  {section.children.map(child => (
                    <li class={`mb-1 ${child.depth === 3 ? 'pl-0' : 'pl-4'}`}>
                      <a href={`#${child.slug}`} class="toc-link block text-gray-500 dark:text-slate-400 no-underline py-1 px-2 rounded transition-all duration-200 text-[0.9375rem] leading-6 hover:text-blue-600 dark:hover:text-blue-400 hover:underline hover:bg-blue-50 dark:hover:bg-slate-700">
                        {child.text}
                      </a>
                    </li>
                  ))}
                </ul>
              </details>
            </li>
          ) : (
            <li class="mb-2">
              <a href={`#${section.heading.slug}`} class="toc-link block text-gray-500 dark:text-slate-400 no-underline py-1 px-2 rounded transition-all duration-200 text-[0.9375rem] leading-6 hover:text-blue-600 dark:hover:text-blue-400 hover:underline hover:bg-blue-50 dark:hover:bg-slate-700">
                {section.heading.text}
              </a>
            </li>
          )
        ))}
      </ul>
    ) : (
      <ul class="list-none p-0 m-0">
        {tocHeadings.map((heading) => (
          <li class={`mb-2 ${
            heading.depth === 1 ? 'pl-0 font-semibold' :
            heading.depth === 2 ? 'pl-0' :
            heading.depth === 3 ? 'pl-4' :
            'pl-8'
          }`}>
            <a href={`#${heading.slug}`} class="toc-link block text-gray-500 dark:text-slate-400 no-underline py-1 px-2 rounded transition-all duration-200 text-[0.9375rem] leading-6 hover:text-blue-600 dark:hover:text-blue-400 hover:underline hover:bg-blue-50 dark:hover:bg-slate-700 focus:outline-2 focus:outline-blue-600 focus:outline-offset-2">
              {heading.text}
            </a>
          </li>
        ))}
      </ul>
    )}
    
    <!-- Back to Top button -->
    <button 
      id="back-to-top"
      class="mt-4 w-full py-2 px-4 text-sm text-gray-600 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-slate-800 rounded transition-colors flex items-center justify-center gap-2 focus:outline-2 focus:outline-blue-600 focus:outline-offset-2"
      aria-label="Back to top"
    >
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
      </svg>
      Back to Top
    </button>
  </details>
</nav>

<style>
  /* Active state styling - uses dynamic class toggling from script */
  .toc-link.active {
    color: #2563eb;
    font-weight: 600;
    border-left: 3px solid #2563eb;
    padding-left: calc(0.5rem - 3px);
    background: #eff6ff;
  }

  .dark .toc-link.active {
    color: #60a5fa;
    border-left-color: #60a5fa;
    background: #1e3a5f;
  }

  /* Toggle icon rotation when details is open */
  .toc-container[open] .toc-toggle-icon {
    transform: rotate(180deg);
  }

  /* Collapsible section styling */
  .toc-section[open] > summary > span:first-child {
    transform: rotate(90deg);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tocLinks = document.querySelectorAll('.toc-link');
    
    // Function to update active link based on hash
    function updateActiveLink(hash: string) {
      tocLinks.forEach(link => {
        link.classList.remove('active');
        const href = link.getAttribute('href');
        if (href === hash) {
          link.classList.add('active');
        }
      });
    }

    // Update on page load
    if (window.location.hash) {
      updateActiveLink(window.location.hash);
    }

    // Update when hash changes (clicking ToC links or browser back/forward)
    window.addEventListener('hashchange', () => {
      updateActiveLink(window.location.hash);
    });

    // Build a map of sections that actually exist in the DOM
    const sectionMap = new Map();
    tocLinks.forEach(link => {
      const href = link.getAttribute('href');
      if (href) {
        const section = document.querySelector(href);
        if (section) {
          sectionMap.set(href, { link, section });
        }
      }
    });

    if (sectionMap.size === 0) return;

    const observerOptions = {
      rootMargin: '-20% 0px -60% 0px',
      threshold: 0
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const id = entry.target.getAttribute('id');
          const targetHref = `#${id}`;
          
          // Only update if we're not navigating via hash (to avoid conflicts)
          if (!window.location.hash || window.location.hash === targetHref) {
            updateActiveLink(targetHref);
            
            // Update URL hash without scrolling
            if (history.replaceState) {
              history.replaceState(null, '', targetHref);
            }
          }
        }
      });
    }, observerOptions);

    // Observe all sections
    sectionMap.forEach(({ section }) => {
      observer.observe(section);
    });

    // Auto-collapse ToC on mobile after clicking a link
    const isMobile = () => window.innerWidth < 769;
    
    tocLinks.forEach(link => {
      link.addEventListener('click', () => {
        if (isMobile()) {
          const details = document.querySelector('.toc-container');
          if (details instanceof HTMLDetailsElement) {
            // Small delay to allow smooth scroll to start
            setTimeout(() => {
              details.open = false;
            }, 100);
          }
        }
      });
    });

    // Back to Top button functionality
    const backToTopButton = document.getElementById('back-to-top');
    if (backToTopButton) {
      backToTopButton.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        // Remove active state from all ToC links
        tocLinks.forEach(link => {
          link.classList.remove('active');
        });
        
        // Update URL to remove hash
        if (history.replaceState) {
          history.replaceState(null, '', window.location.pathname);
        }
      });
    }
  });
</script>
