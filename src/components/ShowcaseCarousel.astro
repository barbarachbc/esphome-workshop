---
interface Props {
  items?: Array<{
    type: 'device' | 'project' | 'note';
    slug: string;
    data: any;
  }>;
  autoPlayInterval?: number; // milliseconds (default: 5000)
}

const { items = [], autoPlayInterval = 5000 } = Astro.props;
---

<div class="showcase-carousel-wrapper" data-auto-interval={autoPlayInterval}>
  {items.length === 0 && (
    <div class="text-center text-lg py-8" style="color: var(--text-secondary);">
      No showcase items selected.
    </div>
  )}
  
  {items.length > 0 && (
    <div class="showcase-carousel">
      <h2 class="showcase-title">âœ¨ Featured</h2>
      
      {/* Carousel container with overflow hidden */}
      <div class="carousel-container" data-carousel-container>
        <div class="carousel-track" data-carousel-track>
          {items.map((item, index) => (
            <div class="carousel-slide" data-slide-index={index}>
              <a href={`/${item.type}s/${item.slug}`} class="carousel-content">
                <div>
                  <h3 class="item-title">{item.data.title}</h3>
                </div>
                <div class="item-details">
                  <p class="item-description">{item.data.description}</p>
                  <div class="item-tags">
                    {item.type === 'device' && (
                      <>
                        <span class="tag tag-primary">{item.data.category}</span>
                        {item.data.connectionTypes?.map((type: string) => (
                          <span class="tag tag-secondary">{type}</span>
                        ))}
                      </>
                    )}
                    {item.type === 'project' && (
                      <>
                        <span class="tag tag-primary">{item.data.difficulty}</span>
                        <span class="tag tag-secondary">{item.data.devices?.length || 0} devices</span>
                        <span class="tag tag-secondary">{item.data.components?.length || 0} components</span>
                      </>
                    )}
                    {item.type === 'note' && (
                      <>
                        <span class="tag tag-primary">{item.data.category}</span>
                        {item.data.difficulty && (
                          <span class="tag tag-secondary">{item.data.difficulty}</span>
                        )}
                      </>
                    )}
                  </div>
                </div>
              </a>
            </div>
          ))}
        </div>
      </div>

      {/* Navigation Controls */}
      <div class="carousel-controls">
        <button 
          class="carousel-btn carousel-prev" 
          data-carousel-prev 
          aria-label="Previous showcase item"
        >
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 18l-6-6 6-6" />
          </svg>
        </button>

        {/* Dot indicators */}
        <div class="carousel-dots" data-carousel-dots>
          {items.map((_, index) => (
            <button 
              class="carousel-dot" 
              data-dot-index={index}
              aria-label={`Go to showcase item ${index + 1}`}
            />
          ))}
        </div>

        <button 
          class="carousel-btn carousel-next" 
          data-carousel-next 
          aria-label="Next showcase item"
        >
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 18l6-6-6-6" />
          </svg>
        </button>
      </div>
    </div>
  )}
</div>

<style>
  .showcase-carousel-wrapper {
    margin-bottom: 2rem;
    padding: 1.25rem;
    border-radius: 0.5rem;
    border: 2px solid var(--accent-blue);
    background: var(--accent-blue-light);
  }

  .showcase-carousel {
    /* No inner border or padding - cleaner look like randomDevice */
  }

  .showcase-title {
    margin: 0 0 1rem 0;
    font-size: 1.25rem;
    color: var(--accent-blue);
  }

  .carousel-container {
    position: relative;
    overflow: hidden;
    border-radius: 0.5rem;
    border: 1px solid var(--border-card);
    background: var(--bg-card);
    padding: 1rem;
  }

  .carousel-track {
    display: flex;
    transition: transform 0.5s ease-in-out;
  }

  .carousel-slide {
    min-width: 100%;
    flex-shrink: 0;
  }

  .carousel-content {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 1.5rem;
    align-items: center;
    text-decoration: none;
    color: inherit;
    cursor: pointer;
    transition: transform 0.2s;
  }

  .carousel-content:hover {
    transform: translateY(-2px);
  }

  .item-title {
    margin: 0;
    font-size: 1.125rem;
    white-space: nowrap;
    color: var(--text-heading);
  }

  .item-details {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .item-description {
    margin: 0;
    font-size: 0.875rem;
    color: var(--text-secondary);
  }

  .item-tags {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .tag {
    display: inline-block;
    font-size: 0.75rem;
    padding: 0.125rem 0.5rem;
    border-radius: 0.25rem;
  }

  .tag-primary {
    background: var(--accent-blue-light);
    color: var(--accent-blue);
  }

  .tag-secondary {
    background: var(--bg-secondary);
    color: var(--text-secondary);
  }

  .carousel-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    margin-top: 1rem;
  }

  .carousel-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    border-radius: 0.375rem;
    background: var(--accent-blue);
    color: white;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
  }

  .carousel-btn:hover {
    background: var(--accent-blue-dark);
    transform: translateY(-2px);
  }

  .carousel-btn:active {
    transform: translateY(0);
  }

  .carousel-btn:focus {
    outline: 2px solid var(--accent-blue);
    outline-offset: 2px;
  }

  .carousel-dots {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }

  .carousel-dot {
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 9999px;
    border: none;
    background: var(--border-secondary);
    cursor: pointer;
    transition: all 0.3s;
    padding: 0;
  }

  .carousel-dot.active {
    width: 1.25rem;
    background: var(--accent-blue);
  }

  .carousel-dot:hover {
    background: var(--accent-blue-dark);
  }

  .carousel-dot:focus {
    outline: 2px solid var(--accent-blue);
    outline-offset: 2px;
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .carousel-track {
      transition: none;
    }
  }
</style>

<script>
  // Carousel functionality - runs once on page load
  function initCarousel() {
    const wrapper = document.querySelector('.showcase-carousel-wrapper') as HTMLElement;
    if (!wrapper) return;

    const track = wrapper.querySelector('[data-carousel-track]') as HTMLElement;
    const slides = wrapper.querySelectorAll('.carousel-slide');
    const prevBtn = wrapper.querySelector('[data-carousel-prev]') as HTMLButtonElement;
    const nextBtn = wrapper.querySelector('[data-carousel-next]') as HTMLButtonElement;
    const dots = wrapper.querySelectorAll('.carousel-dot') as NodeListOf<HTMLButtonElement>;
    
    if (!track || slides.length === 0) return;

    let currentIndex = 0;
    let autoPlayTimer: number | null = null;
    const interval = parseInt(wrapper.dataset.autoInterval || '5000', 10);
    let isPaused = false;
    let longTouchTimer: number | null = null;

    // Update carousel position
    function updateCarousel() {
      track.style.transform = `translateX(-${currentIndex * 100}%)`;
      
      // Update dots
      dots.forEach((dot, index) => {
        dot.classList.toggle('active', index === currentIndex);
      });
    }

    // Go to specific slide
    function goToSlide(index: number) {
      currentIndex = (index + slides.length) % slides.length;
      updateCarousel();
      resetAutoPlay();
    }

    // Next slide
    function nextSlide() {
      goToSlide(currentIndex + 1);
    }

    // Previous slide
    function prevSlide() {
      goToSlide(currentIndex - 1);
    }

    // Auto-play functionality
    function startAutoPlay() {
      if (isPaused || slides.length <= 1) return;
      
      stopAutoPlay();
      autoPlayTimer = window.setInterval(() => {
        nextSlide();
      }, interval);
    }

    function stopAutoPlay() {
      if (autoPlayTimer !== null) {
        clearInterval(autoPlayTimer);
        autoPlayTimer = null;
      }
    }

    function resetAutoPlay() {
      stopAutoPlay();
      if (!isPaused) {
        startAutoPlay();
      }
    }

    function pauseAutoPlay() {
      isPaused = true;
      stopAutoPlay();
    }

    function resumeAutoPlay() {
      isPaused = false;
      startAutoPlay();
    }

    // Event listeners - navigation buttons
    prevBtn?.addEventListener('click', prevSlide);
    nextBtn?.addEventListener('click', nextSlide);

    // Event listeners - dots
    dots.forEach((dot, index) => {
      dot.addEventListener('click', () => goToSlide(index));
    });

    // Event listeners - keyboard navigation
    wrapper.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') {
        e.preventDefault();
        prevSlide();
      } else if (e.key === 'ArrowRight') {
        e.preventDefault();
        nextSlide();
      }
    });

    // Event listeners - pause on hover
    wrapper.addEventListener('mouseenter', pauseAutoPlay);
    wrapper.addEventListener('mouseleave', resumeAutoPlay);

    // Event listeners - long touch for mobile
    wrapper.addEventListener('touchstart', (e) => {
      longTouchTimer = window.setTimeout(() => {
        pauseAutoPlay();
        // Visual feedback that carousel is paused
        wrapper.style.opacity = '0.9';
      }, 500); // 500ms long press
    });

    wrapper.addEventListener('touchend', () => {
      if (longTouchTimer !== null) {
        clearTimeout(longTouchTimer);
        longTouchTimer = null;
      }
      wrapper.style.opacity = '1';
      resumeAutoPlay();
    });

    wrapper.addEventListener('touchmove', () => {
      if (longTouchTimer !== null) {
        clearTimeout(longTouchTimer);
        longTouchTimer = null;
      }
    });

    // Initialize
    updateCarousel();
    if (slides.length > 1) {
      startAutoPlay();
    }

    // Cleanup on page navigation (for view transitions)
    document.addEventListener('astro:before-preparation', () => {
      stopAutoPlay();
      if (longTouchTimer !== null) {
        clearTimeout(longTouchTimer);
      }
    });
  }

  // Initialize on page load
  initCarousel();

  // Re-initialize after view transitions (if enabled)
  document.addEventListener('astro:page-load', initCarousel);
</script>
