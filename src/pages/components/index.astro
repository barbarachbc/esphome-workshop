---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import ComponentCard from '../../components/ComponentCard.astro';
import FilterPanel from '../../components/FilterPanel.astro';

const components = await getCollection('components');
const categories = [...new Set(components.map(c => c.data.category))].sort();

// Collect all unique tags
const allTags = new Set<string>();
components.forEach(c => {
  if (c.data.tags) {
    c.data.tags.forEach(tag => allTags.add(tag));
  }
});
const tags = [...allTags].sort();

// Combine categories and tags into one list
const filters = [
  ...categories.map(cat => ({ type: 'category', value: cat, label: cat })),
  ...tags.map(tag => ({ type: 'tag', value: tag, label: tag }))
];
---

<Layout title="Components">
  <h1 class="text-4xl font-semibold mt-0 mb-6" style="color: var(--text-heading);">Components</h1>
  <p class="text-lg mb-8" style="color: var(--text-secondary);">ESPHome software components and platforms</p>

  <FilterPanel 
    filters={filters}
    itemName="components"
    searchPlaceholder="Search categories and tags..."
    getBadgeLabel={(type) => type === 'category' ? 'category' : 'tag'}
  />

  <div class="grid grid-cols-[repeat(auto-fill,minmax(300px,1fr))] gap-6" id="componentGrid">
    {components.map(component => (
      <div 
        data-category={component.data.category}
        data-tags={component.data.tags ? component.data.tags.join(',') : ''}
      >
        <ComponentCard component={component} />
      </div>
    ))}
  </div>

  <script>
    import { initializeFilters } from '../../utils/filterPills';

    initializeFilters({
      gridSelector: 'componentGrid',
      resultCountId: 'resultCount',
      clearButtonId: 'clearFilters',
      searchInputId: 'filterSearch',
      pillsContainerId: 'activePills',
      filters: [
        {
          name: 'category',
          selector: 'input[name="filter"][data-type="category"]:checked',
          attribute: { name: 'category', isArray: false },
          color: 'var(--accent-blue-light)'
        },
        {
          name: 'tag',
          selector: 'input[name="filter"][data-type="tag"]:checked',
          attribute: { name: 'tags', isArray: true },
          color: 'var(--accent-amber-light)'
        }
      ]
    });
  </script>
</Layout>
