---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import IssueReportButton from '../../components/IssueReportButton.astro';
import LastModified from '../../components/LastModified.astro';
import TableOfContents from '../../components/TableOfContents.astro';

export async function getStaticPaths() {
  const components = await getCollection('components');
  return components.map(component => ({
    params: { slug: component.slug },
    props: { component },
  }));
}

const { component } = Astro.props;
const { Content, headings } = await component.render();

// Build complete ToC including conditional sections
const tocHeadings = [
  // Add "Page Info" link to top
  { depth: 2, slug: 'page-info', text: 'Page Info' },
  // Add markdown headings (H2-H4 only)
  ...headings.filter(h => h.depth >= 2 && h.depth <= 4),
];

// Add conditional sections to ToC
if (component.data.documentation) {
  tocHeadings.push({ depth: 2, slug: 'official-docs', text: 'Official Documentation' });
}

// Get related devices if specified
const allDevices = await getCollection('devices');
let relatedDevices = component.data.relatedDevices && component.data.relatedDevices.length > 0
  ? allDevices.filter(d => component.data.relatedDevices?.includes(d.slug))
  : [];

if (relatedDevices.length > 0) {
  tocHeadings.push({ depth: 2, slug: 'related-devices', text: 'Related Devices' });
}
---

<Layout title={`${component.data.title} - Components`}>
  <div class="grid grid-cols-1 lg:grid-cols-[1fr_300px] gap-8 max-w-7xl mx-auto px-4">
    {tocHeadings.length >= 3 && (
      <div class="lg:hidden mb-8">
        <TableOfContents headings={tocHeadings} />
      </div>
    )}
    
    <article class="min-w-0">
      <div id="page-info" class="mb-8">
        <h1 class="text-4xl font-semibold mb-4">{component.data.title}</h1>
        <div class="flex items-center gap-4 flex-wrap">
          <span class="inline-block bg-blue-600 text-white px-4 py-2 rounded-full text-sm font-semibold">{component.data.category}</span>
          <code class="bg-gray-100 px-4 py-2 rounded text-sm text-pink-700">{component.data.esphomeComponent}</code>
        </div>
      </div>

      <div class="bg-gray-100 p-6 rounded-lg mb-8">
        <p class="m-0 text-lg"><strong>{component.data.description}</strong></p>
      </div>

      <LastModified 
        date={component.data.lastModified}
        verified={component.data.lastVerified}
        showAge={true}
      />

      {component.data.documentation && (
        <div id="official-docs" class="my-8">
          <h2 class="text-2xl font-semibold mb-4">Official Documentation</h2>
          <a href={component.data.documentation} target="_blank" rel="noopener noreferrer" class="inline-block bg-blue-600 text-white px-6 py-3 rounded-lg no-underline font-medium transition-colors duration-200 hover:bg-blue-700">
            üìö ESPHome Documentation ‚Üí
          </a>
        </div>
      )}

      <div class="my-8 prose max-w-none">
        <Content />
      </div>

      {relatedDevices.length > 0 && (
        <div id="related-devices" class="my-8">
          <h2 class="text-2xl font-semibold mb-4">Related Devices</h2>
          <div class="grid grid-cols-[repeat(auto-fill,minmax(250px,1fr))] gap-4">
            {relatedDevices.map(device => (
              <a href={`/devices/${device.slug}`} class="block bg-white border border-gray-200 rounded-lg p-4 no-underline text-gray-800 transition-all duration-200 hover:border-blue-600 hover:-translate-y-0.5">
                <h4 class="m-0 mb-2 text-blue-600 text-base">{device.data.title}</h4>
                <p class="m-0 text-gray-500 text-sm">{device.data.description}</p>
              </a>
            ))}
          </div>
        </div>
      )}

      <a href="/components" class="inline-block mt-8 text-blue-600 no-underline font-medium hover:underline">‚Üê Back to all components</a>

      <IssueReportButton 
        pageType="component"
        pageTitle={component.data.title}
        pageSlug={component.slug}
      />
    </article>

    {tocHeadings.length >= 3 && (
      <aside class="hidden lg:block">
        <div class="sticky top-8 max-h-[calc(100vh-4rem)] overflow-y-auto">
          <TableOfContents headings={tocHeadings} />
        </div>
      </aside>
    )}
  </div>
</Layout>
