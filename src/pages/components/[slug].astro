---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import IssueReportButton from '../../components/IssueReportButton.astro';
import LastModified from '../../components/LastModified.astro';
import TableOfContents from '../../components/TableOfContents.astro';

export async function getStaticPaths() {
  const components = await getCollection('components');
  return components.map(component => ({
    params: { slug: component.slug },
    props: { component },
  }));
}

const { component } = Astro.props;
const { Content, headings } = await component.render();

// Build complete ToC including conditional sections
const tocHeadings = [
  // Add "Page Info" link to top
  { depth: 2, slug: 'page-info', text: 'Page Info' },
  // Add markdown headings (H2-H4 only)
  ...headings.filter(h => h.depth >= 2 && h.depth <= 4),
];

// Add conditional sections to ToC
if (component.data.documentation) {
  tocHeadings.push({ depth: 2, slug: 'official-docs', text: 'Official Documentation' });
}

// Get related devices if specified
const allDevices = await getCollection('devices');
let relatedDevices = component.data.relatedDevices && component.data.relatedDevices.length > 0
  ? component.data.relatedDevices.map(d => ({ description: d.description, device: allDevices.find(ad => ad.slug == d.id)}))
  : [];

// Get related projects if specified
const allProjects = await getCollection('projects');
let relatedProjects = component.data.relatedProjects && component.data.relatedProjects.length > 0
  ? component.data.relatedProjects.map(p => ({ description: p.description, project: allProjects.find(ap => ap.slug == p.id)}))
  : [];

if (relatedDevices.length > 0) {
  tocHeadings.push({ depth: 2, slug: 'related-devices', text: 'Related Devices' });
}

if (relatedProjects.length > 0) {
  tocHeadings.push({ depth: 2, slug: 'related-projects', text: 'Related Projects' });
}
---

<Layout title={`${component.data.title} - Components`}>
  <div class="grid grid-cols-1 lg:grid-cols-[1fr_300px] gap-8 max-w-7xl mx-auto px-4"
       data-pagefind-body
       data-pagefind-filter="Type:Component"
       data-pagefind-filter={`Category:${component.data.category}`}>
    {tocHeadings.length >= 3 && (
      <div class="lg:hidden mb-8">
        <TableOfContents headings={tocHeadings} />
      </div>
    )}
    
    <article class="min-w-0">
      <div id="page-info" class="mb-8">
        <h1 data-pagefind-meta="title" class="text-4xl font-semibold mb-4">{component.data.title}</h1>
        <div class="flex items-center gap-4 flex-wrap">
          <span class="category-badge category-badge-blue">{component.data.category}</span>
          <code class="px-4 py-2 rounded text-sm" style="background: var(--bg-code-inline); color: var(--text-primary);">{component.data.esphomeComponent}</code>
        </div>
      </div>

      <div class="p-6 rounded-lg mb-8" style="background: var(--bg-secondary);">
        <p class="m-0 text-lg" style="color: var(--text-primary);"><strong>{component.data.description}</strong></p>
      </div>

      <LastModified 
        date={component.data.lastModified}
        verified={component.data.lastVerified}
        showAge={true}
      />

      {component.data.documentation && (
        <div id="official-docs" class="my-8">
          <h2 class="text-2xl font-semibold mb-4">Official Documentation</h2>
          <a href={component.data.documentation} target="_blank" rel="noopener noreferrer" class="inline-block px-6 py-3 rounded-lg no-underline font-medium transition-colors duration-200" style="background: var(--accent-blue); color: white;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
            üìö ESPHome Documentation ‚Üí
          </a>
        </div>
      )}

      <div id="_markdown_wrapper" class="my-8 prose max-w-none">
        <Content />
      </div>

      {relatedDevices.length > 0 && (
        <div id="related-devices" class="my-8">
          <h2 class="text-2xl font-semibold mb-4">Related Devices</h2>
          <div class="grid grid-cols-[repeat(auto-fill,minmax(250px,1fr))] gap-4">
            {relatedDevices.map(desc => (
              <a href={`/devices/${desc.device?.slug}`} class="block rounded-lg p-4 no-underline transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md" style="background: var(--bg-card); border: 1px solid var(--border-card); color: var(--text-primary);" onmouseover="this.style.borderColor='var(--accent-blue)'" onmouseout="this.style.borderColor='var(--border-card)'">
                <h4 class="m-0 mb-2 text-base" style="color: var(--text-link);">{desc.device?.data.title}</h4>
                <p class="m-0 text-sm" style="color: var(--text-secondary);">{desc.device?.data.description}</p>
                {desc.description && (
                <p class="m-0 text-sm mt-2 pt-1" style="color: var(--text-secondary); border-top: 1px solid var(--border-primary);">{desc.description}</p>
                )}
              </a>
            ))}
          </div>
        </div>
      )}

      {relatedProjects.length > 0 && (
        <div id="related-projects" class="my-8">
          <h2 class="text-2xl font-semibold mb-4">Related Projects</h2>
          <div class="grid grid-cols-[repeat(auto-fill,minmax(250px,1fr))] gap-4">
            {relatedProjects.filter(desc => desc.project).map(desc => (
              <a href={`/projects/${desc.project?.slug}`} class="block rounded-lg p-4 no-underline transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md" style="background: var(--bg-card); border: 1px solid var(--border-card); color: var(--text-primary);" onmouseover="this.style.borderColor='var(--accent-blue)'" onmouseout="this.style.borderColor='var(--border-card)'">
                <h4 class="m-0 mb-2 text-base" style="color: var(--text-link);">{desc.project?.data.title}</h4>
                <p class="m-0 text-sm" style="color: var(--text-secondary);">{desc.project?.data.description}</p>
                {desc.description && (
                <p class="m-0 text-sm mt-2 pt-1" style="color: var(--text-secondary); border-top: 1px solid var(--border-primary);">{desc.description}</p>
                )}
              </a>
            ))}
          </div>
        </div>
      )}

      <a href="/components" class="inline-block mt-8 no-underline font-medium hover:underline" style="color: var(--text-link);">‚Üê Back to all components</a>

      <IssueReportButton 
        pageType="component"
        pageTitle={component.data.title}
        pageSlug={component.slug}
      />
    </article>

    {tocHeadings.length >= 3 && (
      <aside class="hidden lg:block">
        <div class="sticky top-8 max-h-[calc(100vh-4rem)] overflow-y-auto">
          <TableOfContents headings={tocHeadings} />
        </div>
      </aside>
    )}
  </div>
</Layout>
