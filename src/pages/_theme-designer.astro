---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Theme Designer">
  <div data-pagefind-ignore class="container mx-auto px-4 py-8">
    <div class="mb-8">
      <h1 class="text-4xl font-bold mb-4">Theme Designer</h1>
      <p class="text-lg mb-4">Customize your site's color scheme with real-time preview</p>
      
      <div class="flex gap-4 mb-6">
        <button id="light-mode-btn" class="px-4 py-2 rounded font-medium transition-colors" style="background: var(--accent-blue); color: white;">
          Light Mode
        </button>
        <button id="dark-mode-btn" class="px-4 py-2 rounded font-medium transition-colors" style="background: var(--bg-secondary); color: var(--text-primary);">
          Dark Mode
        </button>
        <button id="reset-btn" class="px-4 py-2 rounded font-medium transition-colors ml-auto" style="background: var(--accent-red-light); color: var(--accent-red);">
          Reset to Defaults
        </button>
      </div>
    </div>

    <!-- Synchronized scrolling containers -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="text-center font-semibold text-lg mb-2" style="color: var(--text-heading);">Preview</div>
      <div class="text-center font-semibold text-lg mb-2" style="color: var(--text-heading);">Color Controls</div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- Left Column: Preview -->
      <div id="preview-scroll" class="overflow-y-auto pr-2" style="max-height: 70vh; border-right: 2px solid var(--border-primary);">
        
        <!-- Section 1: Background Preview -->
        <div class="mb-6 p-6 rounded-lg border scroll-section" data-section="bg" style="background: var(--bg-primary); border-color: var(--border-primary);">
          <h3 class="text-xl font-semibold mb-3">Backgrounds & Text</h3>
          <div class="space-y-3">
            <div class="p-4 rounded" style="background: var(--bg-secondary);">
              <p style="color: var(--text-primary);">Primary text on secondary background</p>
              <p style="color: var(--text-secondary);">Secondary text on secondary background</p>
            </div>
            <div class="p-4 rounded" style="background: var(--bg-card); border: 1px solid var(--border-card);">
              <h4 style="color: var(--text-heading);">Card Heading</h4>
              <p style="color: var(--text-primary);">Primary text in card</p>
              <a href="#" style="color: var(--text-link);">Link text</a>
            </div>
          </div>
        </div>

        <!-- Section 2: Sample Card -->
        <div class="mb-6 rounded-lg overflow-hidden transition-all duration-200 scroll-section" data-section="card" style="background: var(--bg-card); border: 1px solid var(--border-card);">
          <div class="p-6">
            <h3 class="text-xl font-semibold mb-3">Sample Device Card</h3>
            <div class="flex justify-between items-center mb-2">
              <span class="category-badge category-badge-blue">sensor</span>
              <span class="status-badge status-badge-deployed">‚úÖ Deployed</span>
            </div>
            <h4 class="my-2 text-lg" style="color: var(--text-heading);">BME280 Temperature Sensor</h4>
            <p class="my-3 leading-relaxed" style="color: var(--text-secondary);">This is a preview of how device cards look with your current theme settings.</p>
          </div>
          <div class="flex flex-wrap gap-1.5 px-5 py-3 border-t" style="background: var(--bg-secondary); border-color: var(--border-primary);">
            <span class="connection-badge">I2C</span>
            <span class="connection-badge">GPIO</span>
          </div>
        </div>

        <!-- Section 3: Code Block -->
        <div class="mb-6 p-6 rounded-lg border scroll-section" data-section="code" style="background: var(--bg-card); border-color: var(--border-card);">
          <h3 class="text-xl font-semibold mb-3">Code Blocks</h3>
          <p class="mb-2">Inline code: <code>esphome run config.yaml</code></p>
          <pre style="background: var(--bg-code); color: var(--text-code); border: 1px solid var(--border-primary);" class="p-4 rounded-lg"><code>sensor:
  - platform: dht
    pin: GPIO4
    temperature:
      name: "Temperature"</code></pre>
        </div>

        <!-- Section 4: All Badges -->
        <div class="mb-6 p-6 rounded-lg border scroll-section" data-section="badges" style="background: var(--bg-card); border-color: var(--border-card);">
          <h3 class="text-xl font-semibold mb-4">All Badges</h3>
          
          <h4 class="text-lg font-semibold mb-2 mt-4">Status Badges</h4>
          <div class="flex flex-wrap gap-2 mb-4">
            <span class="status-badge status-badge-ready">üì¶ Ready</span>
            <span class="status-badge status-badge-testing">üß™ Testing</span>
            <span class="status-badge status-badge-active">üîß Active</span>
            <span class="status-badge status-badge-deployed">‚úÖ Deployed</span>
            <span class="status-badge status-badge-retired">‚è∏Ô∏è Retired</span>
            <span class="status-badge status-badge-pending">üî¶ Pending</span>
            <span class="status-badge status-badge-unsupported">üö´ Unsupported</span>
          </div>
          <div class="flex flex-wrap gap-2 mb-4">
            <span class="status-badge status-badge-idea">üí≠ Idea</span>
            <span class="status-badge status-badge-in-progress">üõ†Ô∏è In Progress</span>
            <span class="status-badge status-badge-completed">‚úÖ Completed</span>
            <span class="status-badge status-badge-abandoned">‚è∏Ô∏è Abandoned</span>
          </div>

          <h4 class="text-lg font-semibold mb-2 mt-4">Difficulty Badges</h4>
          <div class="flex flex-wrap gap-2 mb-4">
            <span class="difficulty-badge difficulty-badge-beginner">Beginner</span>
            <span class="difficulty-badge difficulty-badge-intermediate">Intermediate</span>
            <span class="difficulty-badge difficulty-badge-advanced">Advanced</span>
          </div>

          <h4 class="text-lg font-semibold mb-2 mt-4">Category Badges</h4>
          <div class="flex flex-wrap gap-2 mb-4">
            <span class="category-badge category-badge-purple">Notes</span>
            <span class="category-badge category-badge-blue">Devices</span>
            <span class="category-badge category-badge-emerald">Components</span>
          </div>

          <h4 class="text-lg font-semibold mb-2 mt-4">Tag & Connection Badges</h4>
          <div class="flex flex-wrap gap-2 mb-4">
            <span class="tag-badge">Tag Example</span>
            <span class="connection-badge">I2C</span>
            <span class="connection-badge">SPI</span>
            <span class="connection-badge">GPIO</span>
          </div>

          <h4 class="text-lg font-semibold mb-2 mt-4">Filter Pills</h4>
          <div class="flex flex-wrap gap-2">
            <span class="filter-pill filter-pill-blue">
              <span>Category Filter</span>
              <button class="pill-remove" aria-label="Remove filter">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </span>
            <span class="filter-pill filter-pill-emerald">
              <span>Status Filter</span>
              <button class="pill-remove" aria-label="Remove filter">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </span>
            <span class="filter-pill filter-pill-amber">
              <span>Tag Filter</span>
              <button class="pill-remove" aria-label="Remove filter">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </span>
          </div>
        </div>

      </div>

      <!-- Right Column: Color Controls -->
      <div id="controls-scroll" class="overflow-y-auto pl-2" style="max-height: 70vh;">
        
        <!-- Section 1: Background & Text Colors -->
        <div class="p-4 rounded-lg border mb-6 scroll-section" data-section="bg" style="background: var(--bg-card); border-color: var(--border-card);">
          <h3 class="text-lg font-semibold mb-3">Background Colors</h3>
          <div class="space-y-2" id="bg-colors"></div>
          
          <h3 class="text-lg font-semibold mb-3 mt-6">Text Colors</h3>
          <div class="space-y-2" id="text-colors"></div>
          
          <h3 class="text-lg font-semibold mb-3 mt-6">Border Colors</h3>
          <div class="space-y-2" id="border-colors"></div>
        </div>

        <!-- Section 2: Card-specific colors (empty spacer to align with card preview) -->
        <div class="mb-6" style="min-height: 280px;">
          <div class="p-4 rounded-lg border" style="background: var(--bg-card); border-color: var(--border-card);">
            <p class="text-sm" style="color: var(--text-secondary);">‚Üê Card uses Background, Text, and Border colors above</p>
          </div>
        </div>

        <!-- Section 3: Code Colors -->
        <div class="p-4 rounded-lg border mb-6 scroll-section" data-section="code" style="background: var(--bg-card); border-color: var(--border-card);">
          <h3 class="text-lg font-semibold mb-3">Code Colors</h3>
          <div class="space-y-2" id="code-colors"></div>
        </div>

        <!-- Section 4: Accent Colors (for badges) -->
        <div class="p-4 rounded-lg border mb-6 scroll-section" data-section="badges" style="background: var(--bg-card); border-color: var(--border-card);">
          <h3 class="text-lg font-semibold mb-3">Accent Colors (Badges)</h3>
          <div class="space-y-2" id="accent-colors"></div>
        </div>

      </div>
    </div>

    <!-- Generated CSS Output -->
    <div class="mt-8 p-6 rounded-lg border" style="background: var(--bg-card); border-color: var(--border-card);">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-semibold">Generated CSS</h2>
        <button id="copy-css-btn" class="px-4 py-2 rounded font-medium transition-colors" style="background: var(--accent-blue); color: white;">
          Copy to Clipboard
        </button>
      </div>
      <pre id="css-output" class="p-4 rounded-lg overflow-x-auto" style="background: var(--bg-code); color: var(--text-code); max-height: 500px; overflow-y: auto;"><code></code></pre>
    </div>
  </div>

  <script>
    // Read theme values directly from computed CSS variables
    function readThemeFromCSS(isDark: boolean = false): Record<string, string> {
      // Create a temporary element to read CSS variables
      const testElement = document.createElement('div');
      if (isDark) {
        testElement.className = 'dark';
      }
      testElement.style.display = 'none';
      document.body.appendChild(testElement);
      
      const computedStyle = getComputedStyle(testElement);
      
      // List of all CSS variables we want to read
      const cssVars = [
        'bg-primary', 'bg-secondary', 'bg-tertiary', 'bg-card', 'bg-card-hover',
        'bg-header', 'bg-nav', 'bg-footer', 'bg-code', 'bg-code-inline', 'bg-note',
        'text-primary', 'text-secondary', 'text-tertiary', 'text-inverse', 'text-heading',
        'text-link', 'text-link-hover', 'text-code', 'text-hero',
        'border-primary', 'border-secondary', 'border-accent', 'border-card',
        'accent-blue', 'accent-blue-light', 'accent-blue-dark',
        'accent-emerald', 'accent-emerald-light',
        'accent-amber', 'accent-amber-light', 'accent-yellow-light',
        'accent-red', 'accent-red-light',
        'accent-purple', 'accent-purple-light',
        'accent-orange', 'accent-orange-light',
        'accent-pink', 'accent-pink-light',
      ];
      
      const theme: Record<string, string> = {};
      cssVars.forEach(varName => {
        const value = computedStyle.getPropertyValue(`--${varName}`).trim();
        if (value) {
          theme[varName] = value;
        }
      });
      
      document.body.removeChild(testElement);
      return theme;
    }

    // Read themes from CSS on page load
    const lightTheme = readThemeFromCSS(false);
    const darkTheme = readThemeFromCSS(true);

    let currentTheme = {...lightTheme};
    let isDarkMode = false;

    // Initialize color controls
    function initColorControls() {
      const bgColors = document.getElementById('bg-colors');
      const textColors = document.getElementById('text-colors');
      const borderColors = document.getElementById('border-colors');
      const codeColors = document.getElementById('code-colors');
      const accentColors = document.getElementById('accent-colors');

      const bgVars = Object.keys(currentTheme).filter(k => k.startsWith('bg-') && !k.includes('code'));
      const textVars = Object.keys(currentTheme).filter(k => k.startsWith('text-') && !k.includes('code'));
      const borderVars = Object.keys(currentTheme).filter(k => k.startsWith('border-'));
      const codeVars = Object.keys(currentTheme).filter(k => k.includes('code'));
      const accentVars = Object.keys(currentTheme).filter(k => k.startsWith('accent-'));

      if (bgColors) bgColors.innerHTML = bgVars.map(v => createColorInput(v)).join('');
      if (textColors) textColors.innerHTML = textVars.map(v => createColorInput(v)).join('');
      if (borderColors) borderColors.innerHTML = borderVars.map(v => createColorInput(v)).join('');
      if (codeColors) codeColors.innerHTML = codeVars.map(v => createColorInput(v)).join('');
      if (accentColors) accentColors.innerHTML = accentVars.map(v => createColorInput(v)).join('');

      // Add event listeners
      document.querySelectorAll('.color-input').forEach(input => {
        input.addEventListener('input', (e) => {
          const target = e.target as HTMLInputElement;
          const varName = target.dataset.var;
          if (varName) {
            currentTheme[varName as keyof typeof currentTheme] = target.value;
            applyTheme();
            updateCSSOutput();
          }
        });
      });
    }

    function createColorInput(varName) {
      const displayName = varName.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      return `
        <div class="flex items-center gap-3 mb-2">
          <input type="color" 
                 class="color-input w-12 h-8 rounded cursor-pointer" 
                 data-var="${varName}" 
                 value="${currentTheme[varName]}">
          <div class="flex-1">
            <label class="block text-sm font-medium" style="color: var(--text-primary);">${displayName}</label>
            <input type="text" 
                   class="color-text-input w-full px-2 py-1 rounded text-sm font-mono" 
                   style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-primary);"
                   data-var="${varName}" 
                   value="${currentTheme[varName]}">
          </div>
        </div>
      `;
    }

    function applyTheme() {
      const root = document.documentElement;
      Object.entries(currentTheme).forEach(([key, value]) => {
        root.style.setProperty(`--${key}`, value);
      });
      
      // Sync text inputs with color inputs
      document.querySelectorAll('.color-text-input').forEach(input => {
        input.value = currentTheme[input.dataset.var];
      });
      document.querySelectorAll('.color-input').forEach(input => {
        input.value = currentTheme[input.dataset.var];
      });
    }

    function updateCSSOutput() {
      const mode = isDarkMode ? '.dark' : ':root';
      const css = `${mode} {\n  /* Background Colors */\n${formatCSSVars('bg')}\n  \n  /* Text Colors */\n${formatCSSVars('text')}\n  \n  /* Border Colors */\n${formatCSSVars('border')}\n  \n  /* Accent Colors */\n${formatCSSVars('accent')}\n}`;
      
      document.querySelector('#css-output code').textContent = css;
    }

    function formatCSSVars(prefix) {
      return Object.entries(currentTheme)
        .filter(([key]) => key.startsWith(prefix + '-'))
        .map(([key, value]) => `  --${key}: ${value};`)
        .join('\n');
    }

    // Event listeners
    document.getElementById('light-mode-btn').addEventListener('click', () => {
      isDarkMode = false;
      currentTheme = {...lightTheme};
      document.documentElement.classList.remove('dark');
      updateButtonStates();
      initColorControls();
      applyTheme();
      updateCSSOutput();
    });

    document.getElementById('dark-mode-btn').addEventListener('click', () => {
      isDarkMode = true;
      currentTheme = {...darkTheme};
      document.documentElement.classList.add('dark');
      updateButtonStates();
      initColorControls();
      applyTheme();
      updateCSSOutput();
    });

    document.getElementById('reset-btn').addEventListener('click', () => {
      if (confirm('Reset to default theme colors?')) {
        currentTheme = isDarkMode ? {...darkTheme} : {...lightTheme};
        initColorControls();
        applyTheme();
        updateCSSOutput();
      }
    });

    document.getElementById('copy-css-btn')?.addEventListener('click', () => {
      const cssElement = document.querySelector('#css-output code');
      const css = cssElement?.textContent || '';
      navigator.clipboard.writeText(css).then(() => {
        const btn = document.getElementById('copy-css-btn');
        if (!btn) return;
        const originalText = btn.textContent;
        btn.textContent = '‚úì Copied!';
        btn.style.background = 'var(--accent-emerald)';
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = 'var(--accent-blue)';
        }, 2000);
      });
    });

    // Add text input listeners
    document.addEventListener('input', (e) => {
      const target = e.target as HTMLElement;
      if (target && target.classList.contains('color-text-input')) {
        const inputTarget = target as HTMLInputElement;
        const varName = inputTarget.dataset.var;
        const value = inputTarget.value;
        if (varName && /^#[0-9A-Fa-f]{6}$/.test(value)) {
          currentTheme[varName as keyof typeof currentTheme] = value;
          applyTheme();
          updateCSSOutput();
        }
      }
    });

    function updateButtonStates() {
      const lightBtn = document.getElementById('light-mode-btn');
      const darkBtn = document.getElementById('dark-mode-btn');
      
      if (!lightBtn || !darkBtn) return;
      
      if (isDarkMode) {
        darkBtn.style.background = 'var(--accent-blue)';
        darkBtn.style.color = 'white';
        lightBtn.style.background = 'var(--bg-secondary)';
        lightBtn.style.color = 'var(--text-primary)';
      } else {
        lightBtn.style.background = 'var(--accent-blue)';
        lightBtn.style.color = 'white';
        darkBtn.style.background = 'var(--bg-secondary)';
        darkBtn.style.color = 'var(--text-primary)';
      }
    }

    // Synchronized scrolling
    let isScrolling = false;
    const previewScroll = document.getElementById('preview-scroll');
    const controlsScroll = document.getElementById('controls-scroll');

    if (previewScroll && controlsScroll) {
      previewScroll.addEventListener('scroll', () => {
        if (!isScrolling) {
          isScrolling = true;
          controlsScroll.scrollTop = previewScroll.scrollTop;
          setTimeout(() => { isScrolling = false; }, 10);
        }
      });

      controlsScroll.addEventListener('scroll', () => {
        if (!isScrolling) {
          isScrolling = true;
          previewScroll.scrollTop = controlsScroll.scrollTop;
          setTimeout(() => { isScrolling = false; }, 10);
        }
      });
    }

    // Initialize
    initColorControls();
    applyTheme();
    updateCSSOutput();
    updateButtonStates();
  </script>
</Layout>
