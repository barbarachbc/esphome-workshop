---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import NoteCard from '../../components/NoteCard.astro';
import FilterPanel from '../../components/FilterPanel.astro';

const notes = await getCollection('notes');

// Collect all unique tags
const allTags = new Set<string>();
notes.forEach(n => {
  if (n.data.tags) {
    n.data.tags.forEach(tag => allTags.add(tag));
  }
});
const tags = [...allTags].sort();

// Calculate age category for each note based on lastUpdated
const now = new Date();
const notesWithAge = notes.map(note => {
  let age = 'unknown';
  if (note.data.lastUpdated) {
    const lastUpdate = new Date(note.data.lastUpdated);
    const daysDiff = Math.floor((now.getTime() - lastUpdate.getTime()) / (1000 * 60 * 60 * 24));
    if (daysDiff <= 30) age = '30days';
    else if (daysDiff <= 90) age = '90days';
    else if (daysDiff <= 365) age = '1year';
    else age = 'older';
  }
  return { ...note, age };
});

// Define age filter options
const ageFilters = [
  { value: '30days', label: 'Recently updated' },
  { value: '90days', label: 'Updated 1-3 months ago' },
  { value: '1year', label: 'Updated 3-12 months ago' },
  { value: 'older', label: 'Not updated in over a year' },
];

// Combine age filters first (in order), then tags alphabetically
const filters = [
  ...ageFilters.map(af => ({ type: 'age', value: af.value, label: af.label })),
  ...tags.map(tag => ({ type: 'tag', value: tag, label: tag }))
];
---

<Layout title="Notes - My ESPHome Workshop">
  <h1 class="text-4xl font-semibold mt-0 mb-6" style="color: var(--text-heading);">Notes & Guides</h1>
  <p class="text-lg mb-8" style="color: var(--text-secondary);">Setup guides, networking tricks, and lessons learned along the way</p>

  <FilterPanel 
    filters={filters}
    itemName="notes"
    searchPlaceholder="Search tags and timeframes..."
    getBadgeLabel={(type) => type === 'tag' ? 'tag' : 'updated'}
  />

  <div class="grid grid-cols-[repeat(auto-fill,minmax(320px,1fr))] gap-6" id="noteGrid">
    {notesWithAge.map(note => (
      <div 
        data-tags={note.data.tags ? note.data.tags.join(',') : ''}
        data-age={note.age}
      >
        <NoteCard note={note} />
      </div>
    ))}
  </div>

  {notes.length === 0 && (
    <p class="text-center p-12 text-lg" style="color: var(--text-secondary);">No notes yet. Start documenting your journey!</p>
  )}

  <script>
    import { initializeFilters } from '../../utils/filterPills';

    initializeFilters({
      gridSelector: 'noteGrid',
      resultCountId: 'resultCount',
      clearButtonId: 'clearFilters',
      searchInputId: 'filterSearch',
      pillsContainerId: 'activePills',
      filters: [
        {
          name: 'tag',
          selector: 'input[name="filter"][data-type="tag"]:checked',
          attribute: { name: 'tags', isArray: true },
          color: 'var(--accent-amber-light)'
        },
        {
          name: 'age',
          selector: 'input[name="filter"][data-type="age"]:checked',
          attribute: { name: 'age', isArray: false },
          color: 'var(--accent-blue-light)'
        }
      ]
    });
  </script>
</Layout>
