---
import Layout from '../layouts/Layout.astro';
import ShowcaseCarousel from '../components/ShowcaseCarousel.astro';
import { getEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import { getRecentChanges, formatChangelogDate, getChangeTypeEmoji } from '../utils/changelog';
import Search from "astro-pagefind/components/Search";

// Query all devices and projects
const allDevices = await getCollection('devices');
const allProjects = await getCollection('projects');


const showcase = [
  { type: 'device', slug: 'gc9a01-round-lcd' },
  { type: 'project', slug: 'info-panel-28' },
  { type: 'note', slug: 'mdns-docker-setup' },
];

// Fetch full data for each showcase item
const showcaseItems = await Promise.all(
  showcase.map(async (item) => {
    if (item.type === 'device') {
      const entry = await getEntry('devices', item.slug);
      return entry ? { type: 'device', ...entry } : null;
    }
    if (item.type === 'project') {
      const entry = await getEntry('projects', item.slug);
      return entry ? { type: 'project', ...entry } : null;
    }
    if (item.type === 'note') {
      const entry = await getEntry('notes', item.slug);
      return entry ? { type: 'note', ...entry } : null;
    }
    return null;
  })
);

// Compute display status for each device based on project usage
const devicesWithComputedStatus = allDevices.map(device => {
  const projectsUsingDevice = allProjects.filter(project => {
    const hasDevices = project.data.devices && Array.isArray(project.data.devices);
    if (!hasDevices) return false;
    
    const deviceSlugLower = device.slug.toLowerCase();
    return project.data.devices.some(d => d.toLowerCase() === deviceSlugLower);
  });

  let displayStatus: 'ready' | 'testing' | 'active' | 'deployed' | 'retired' | 'pending' | 'unsupported' = device.data.status;
  
  // Only override if device is currently marked as 'ready'
  if (projectsUsingDevice.length > 0 && device.data.status === 'ready') {
    const hasDeployedProject = projectsUsingDevice.some(p => p.data.status === 'completed');
    const hasInProgressProject = projectsUsingDevice.some(p => p.data.status === 'in-progress');
    
    if (hasDeployedProject) {
      displayStatus = 'deployed';
    } else if (hasInProgressProject) {
      displayStatus = 'active';
    }
  }

  return {
    ...device,
    displayStatus
  };
});

// Calculate stats based on computed status
const deviceStats = {
  total: devicesWithComputedStatus.length,
  ready: devicesWithComputedStatus.filter(d => d.displayStatus === 'ready').length,
  testing: devicesWithComputedStatus.filter(d => d.displayStatus === 'testing').length,
  active: devicesWithComputedStatus.filter(d => d.displayStatus === 'active').length,
  deployed: devicesWithComputedStatus.filter(d => d.displayStatus === 'deployed').length,
  retired: devicesWithComputedStatus.filter(d => d.displayStatus === 'retired').length,
  pending: devicesWithComputedStatus.filter(d => d.displayStatus === 'pending').length,
  unsupported: devicesWithComputedStatus.filter(d => d.displayStatus === 'unsupported').length,
};

const projectStats = {
  total: allProjects.length,
  ideas: allProjects.filter(p => p.data.status === 'idea').length,
  inProgress: allProjects.filter(p => p.data.status === 'in-progress').length,
  completed: allProjects.filter(p => p.data.status === 'completed').length,
  abandoned: allProjects.filter(p => p.data.status === 'abandoned').length,
};

// Query all notes
const allNotes = await getCollection('notes');
const noteStats = {
  total: allNotes.length,
};

// Get ready, testing, or active devices for random picker (using computed status)
const availableDevices = devicesWithComputedStatus.filter(d => 
  d.displayStatus === 'ready' || d.displayStatus === 'testing' || d.displayStatus === 'active'
);

// Pick random one
const randomDevice = availableDevices.length > 0 
  ? availableDevices[Math.floor(Math.random() * availableDevices.length)]
  : null;

// Random hero descriptions (after the first one)
const heroDescriptions = [
  "This is my personal documentation as I turn all my junk into smart home devices.",
  "As they say - one man's garbage is another man's treasure, just in this case I'm that same man! ğŸ˜‚ Maybe the world just wasn't ready for me all these years!",
  "Let's Take the Power Back! âœŠ",
  "My home my rules ğŸ›–! ... well, as long as wife's approval rating is high ğŸ“ˆ",
  "Fight the e-waste â™»ï¸"
];

const randomHeroDescription = heroDescriptions[Math.floor(Math.random() * heroDescriptions.length)];

// Get recent changes for "What's New" section
const recentChanges = await getRecentChanges(7);
---

<Layout title="Home">
  <div class="text-center py-12 rounded-lg mb-12 border" style="background: var(--bg-hero); color: var(--text-hero); border-color: var(--border-primary);">
    <h1 class="m-0 mb-4 text-4xl" style="color: var(--text-hero);">My ESPHome Workshop</h1>
    <p class="text-lg max-w-2xl mx-auto mb-4" style="color: var(--text-hero); opacity: 0.95;">
      After 15+ years collecting dev boards, sensors, and random gadgets, 
      it's finally time to build something useful. This whole website is for using my existing
      devices to create projects using <a href="https://esphome.io/" target="_blank" rel="noopener noreferrer"  class="herolink">ESPHome</a> and use them in 
      <a href="https://www.home-assistant.io/"  target="_blank" rel="noopener noreferrer" class="herolink">Home Assistant</a> or on their own.
    </p>
    <p class="text-lg max-w-2xl mx-auto mb-0" style="color: var(--text-hero); opacity: 0.95;">{randomHeroDescription}</p>
  </div>

  <ShowcaseCarousel items={showcaseItems.filter(Boolean)} />
  <Search className="mb-8 pagefind-ui yellow" uiOptions={{ showImages: false }} />

  <div class="grid grid-cols-2 gap-6 mb-8">
    <a href="/devices" class="block rounded-lg p-5 no-underline transition-all duration-200 shadow-sm hover:-translate-y-0.5 hover:shadow-xl" style="background: var(--bg-card); border: 1px solid var(--border-card); color: var(--text-primary);">
      <div class="flex justify-between items-center mb-2">
        <h2 class="m-0 mb-2 text-xl" style="color: var(--accent-blue);">ğŸ“Ÿ Devices</h2>
        <div class="text-5xl font-bold" style="color: var(--accent-blue);">{deviceStats.total}</div>
      </div>
      <p class="m-0 mb-4 text-sm" style="color: var(--text-secondary);">Browse physical hardware - boards, sensors, displays, and more.</p>
      <div class="flex flex-col gap-2 text-sm">
        <span class="status-badge status-badge-deployed">âœ… {deviceStats.deployed} deployed</span>
        <span class="status-badge status-badge-active">ğŸ”§ {deviceStats.active} active</span>
        <span class="status-badge status-badge-testing">ğŸ§ª {deviceStats.testing} testing</span>
        <span class="status-badge status-badge-ready">ğŸ“¦ {deviceStats.ready} ready</span>
        <span class="status-badge status-badge-pending">ğŸ”¦ {deviceStats.pending} pending</span>
        <span class="status-badge status-badge-unsupported">ğŸš« {deviceStats.unsupported} unsupported</span>
        {deviceStats.retired > 0 && (
          <span class="status-badge status-badge-retired">â¸ï¸ {deviceStats.retired} retired</span>
        )}
      </div>
    </a>

    <a href="/projects" class="block rounded-lg p-5 no-underline transition-all duration-200 shadow-sm hover:-translate-y-0.5 hover:shadow-xl" style="background: var(--bg-card); border: 1px solid var(--border-card); color: var(--text-primary);">
      <div class="flex justify-between items-center mb-2">
        <h2 class="m-0 mb-2 text-xl" style="color: var(--accent-blue);">ğŸ’¡ Projects</h2>
        <div class="text-5xl font-bold" style="color: var(--accent-blue);">{projectStats.total}</div>
      </div>
      <p class="m-0 mb-4 text-sm" style="color: var(--text-secondary);">Complete projects with wiring and configuration.</p>
      <div class="flex flex-col gap-2 text-sm">
        <span class="status-badge status-badge-completed">âœ… {projectStats.completed} completed</span>
        <span class="status-badge status-badge-in-progress">ğŸ› ï¸ {projectStats.inProgress} in progress</span>
        <span class="status-badge status-badge-idea">ğŸ’­ {projectStats.ideas} ideas</span>
        {projectStats.abandoned > 0 && (
          <span class="status-badge status-badge-abandoned">â¸ï¸ {projectStats.abandoned} abandoned</span>
        )}
      </div>
    </a>
  </div>

  {randomDevice && (
    <div class="mb-8 p-5 rounded-lg border-2" style="background: var(--accent-blue-light); border-color: var(--accent-blue);">
      <h2 class="m-0 mb-4 text-xl" style="color: var(--accent-blue);">ğŸ² Random Device to Try Next</h2>
      <div class="p-4 rounded-lg grid grid-cols-[auto_1fr] gap-6 items-center border" style="background: var(--bg-card); border-color: var(--border-card);">
        <div>
          <h3 class="m-0 text-lg whitespace-nowrap" style="color: var(--text-heading);">{randomDevice.data.title}</h3>
        </div>
        <div class="flex flex-col gap-2">
          <p class="m-0 text-sm" style="color: var(--text-secondary);">{randomDevice.data.description}</p>
          <div class="flex gap-2 flex-wrap">
            <span class="inline-block text-xs px-2 py-0.5 rounded" style="background: var(--accent-blue-light); color: var(--accent-blue);">
              {randomDevice.data.category}
            </span>
            {randomDevice.data.connectionTypes.map(type => (
              <span class="inline-block text-xs px-2 py-0.5 rounded" style="background: var(--bg-secondary); color: var(--text-secondary);">{type}</span>
            ))}
          </div>
          <a href={`/devices/${randomDevice.slug}`} 
             class="inline-block w-fit px-4 py-2 text-white no-underline rounded-lg font-medium text-sm transition-all duration-200 hover:-translate-y-0.5" 
             style="background: var(--accent-blue);">
            Let's Use This!
          </a>
        </div>
      </div>
    </div>
  )}

  {recentChanges.length > 0 && (
    <div class="mb-8 p-5 rounded-lg border" style="background: var(--bg-card); border-color: var(--border-card);">
      <h2 class="m-0 mb-4 text-xl" style="color: var(--text-heading);">âœ¨ What's New</h2>
      <div class="flex flex-col gap-3">
        {recentChanges.map(change => (
          <div class="flex items-baseline gap-2 text-sm px-2 py-2 rounded transition-colors duration-200" onmouseover="this.style.background='var(--bg-secondary)';" onmouseout="this.style.background='transparent';">
            <span class="shrink-0">{getChangeTypeEmoji(change.type)}</span>
            <span class="shrink-0 font-medium capitalize" style="color: var(--text-secondary);">{change.type}:</span>
            <a href={`/${change.contentType}s/${change.slug}`} 
               class="no-underline font-medium transition-colors duration-200" style="color: var(--text-link);">
              {change.title}
            </a>
            <span style="color: var(--text-secondary);">- {change.description}</span>
            <span class="text-[0.85rem] ml-auto shrink-0" style="color: var(--text-secondary);">
              ({formatChangelogDate(change.date)})
            </span>
          </div>
        ))}
      </div>
    </div>
  )}

  <div class="grid grid-cols-2 gap-5 mb-12">
    <a href="/components" class="block rounded-lg p-5 no-underline transition-all duration-200 shadow-sm hover:-translate-y-0.5 hover:shadow-xl" style="background: var(--bg-card); border: 1px solid var(--border-card); color: var(--text-primary);">
      <h2 class="m-0 mb-2 text-xl" style="color: var(--accent-blue);">ğŸ”§ Components</h2>
      <p class="m-0 text-sm" style="color: var(--text-secondary);">Explore ESPHome software components and platforms.</p>
    </a>
    <a href="/notes" class="block rounded-lg p-5 no-underline transition-all duration-200 shadow-sm hover:-translate-y-0.5 hover:shadow-xl" style="background: var(--bg-card); border: 1px solid var(--border-card); color: var(--text-primary);">
      <h2 class="m-0 mb-2 text-xl" style="color: var(--accent-blue);">ğŸ““ Notes</h2>
      <p class="m-0 text-sm" style="color: var(--text-secondary);">Setup guides, networking tricks, and lessons learned along the way.</p>
    </a>
  </div>
</Layout>
