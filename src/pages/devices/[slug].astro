---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import IssueReportButton from '../../components/IssueReportButton.astro';
import LastModified from '../../components/LastModified.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import {connectionTypeMap} from '../../utils/connectionType';

// Import the function to get devices in the display comparison
import { displayComparison } from './all-displays.astro';

export async function getStaticPaths() {
  const devices = await getCollection('devices');
  return devices.map(device => ({
    params: { slug: device.slug },
    props: { device },
  }));
}

const { device } = Astro.props;
const { Content, headings } = await device.render();

// Build complete ToC including conditional sections
const tocHeadings = [
  // Add "Page Info" link to top
  { depth: 2, slug: 'page-info', text: 'Page Info' },
  // Add markdown headings (H2-H4 only)
  ...headings.filter(h => h.depth >= 2 && h.depth <= 4),
];

// Add conditional sections to ToC if they exist in frontmatter
if (device.data.references && device.data.references.length > 0) {
  tocHeadings.push({ depth: 2, slug: 'references', text: 'References' });
}
if (device.data.purchaseLinks && device.data.purchaseLinks.length > 0) {
  tocHeadings.push({ depth: 2, slug: 'where-to-buy', text: 'Where to Buy' });
}

// Get projects using this device
const allProjects = await getCollection('projects');
const projectsUsingDevice = allProjects.filter(project => {
  const hasDevices = project.data.devices && Array.isArray(project.data.devices);
  if (!hasDevices) return false;
  
  // Case-insensitive comparison
  const deviceSlugLower = device.slug.toLowerCase();
  return project.data.devices.some(d => d.toLowerCase() === deviceSlugLower);
});

const statusLabels = {
  ready: 'üì¶ Ready',
  testing: 'üß™ Testing',
  active: 'üîß Active',
  deployed: '‚úÖ Deployed',
  pending: 'üî¶ Pending',
  unsupported: 'üö´ Unsupported',
  retired: '‚è∏Ô∏è Retired',
};

const projectStatusLabels = {
  idea: 'üí≠ Idea',
  'in-progress': 'üõ†Ô∏è In Progress',
  completed: '‚úÖ Completed',
  abandoned: '‚è∏Ô∏è Abandoned',
};

const productionStatusLabels = {
  active: '‚úÖ Active',
  NRND: '‚ö†Ô∏è Not Recommended for New Designs',
  discontinued: '‚ùå Discontinued',
  obsolete: '‚ùå Obsolete',
  unknown: '‚ùì Unknown',
};

// Check if this device is in the display comparison
const isInDisplayComparison = displayComparison.hotspots.some(x => x.deviceSlug === device.slug);
console.log(isInDisplayComparison);
// Automatically determine device status based on project usage
let displayStatus: 'ready' | 'testing' | 'active' | 'deployed' | 'retired' | 'pending' | 'unsupported' = device.data.status;
if (projectsUsingDevice.length > 0) {
  // Only override if device is currently marked as 'ready'
  // This allows manual 'testing', 'deployed', or 'retired' status to be preserved
  if (device.data.status === 'ready') {
    // Check project statuses to determine device status
    const hasDeployedProject = projectsUsingDevice.some(p => p.data.status === 'completed');
    const hasInProgressProject = projectsUsingDevice.some(p => p.data.status === 'in-progress');
    
    if (hasDeployedProject) {
      displayStatus = 'deployed';
    } else if (hasInProgressProject) {
      displayStatus = 'active';
    }
  }
}
---

<Layout title={`${device.data.title} - Devices`}>
  <div class="grid grid-cols-1 lg:grid-cols-[1fr_300px] gap-8 max-w-7xl mx-auto" 
       data-pagefind-body
       data-pagefind-filter="Type:Device"
       data-pagefind-filter={`Category:${device.data.category}`}
       data-pagefind-filter={`Status:${displayStatus}`}>
    {tocHeadings.length >= 3 && (
      <div class="lg:hidden mb-8">
        <TableOfContents headings={tocHeadings} />
      </div>
    )}
    
    <article class="min-w-0">
      <div id="page-info" class="flex justify-between items-center mb-4 flex-wrap gap-4">
        <h1 class="text-4xl font-semibold m-0" data-pagefind-meta="title">{ device.data.title}</h1>
        <div class="flex gap-2 items-center flex-wrap">
          {device.data.productionStatus && device.data.productionStatus !== 'unknown' && (
            <span class={`inline-block text-sm px-3 py-2 rounded-lg font-medium ${
              device.data.productionStatus === 'active' ? 'status-badge-deployed' :
              device.data.productionStatus === 'NRND' ? 'status-badge-testing' :
              'status-badge-unsupported'
            }`}>
              {productionStatusLabels[device.data.productionStatus]}
            </span>
          )}
          <span class={`status-badge status-badge-${displayStatus}`}>
            {statusLabels[displayStatus]}
          </span>
        </div>
      </div>

      <div class="flex items-center gap-4 flex-wrap mb-8">
        <span class="inline-block text-white px-4 py-2 rounded-full text-sm font-semibold" style="background: var(--accent-blue);">{device.data.category}</span>
        {device.data.manufacturer && (
          <span class="text-secondary text-sm">{device.data.manufacturer}</span>
        )}
        {device.data.model && (
          <span class="text-secondary text-sm">Model: {device.data.model}</span>
        )}
        {device.data.variants && device.data.variants.length > 0 && (
          device.data.variants.map(variant => (
            <span class="inline-block px-3 py-1 rounded-full text-xs font-medium" style="background: var(--accent-blue-light); color: var(--accent-blue);">{variant}</span>
          ))
        )}
        {device.data.dateAcquired && (
          <span class="text-secondary text-sm">üìÖ Acquired: {device.data.dateAcquired}</span>
        )}
      </div>

      <div class="p-6 rounded-lg mb-8" style="background: var(--bg-secondary);">
        <p class="m-0 text-lg"><strong>{device.data.description}</strong></p>
      </div>

      <LastModified 
        date={device.data.lastModified}
        verified={device.data.lastVerified}
        showAge={true}
      />

      {projectsUsingDevice.length > 0 && (
        <details class="group border rounded-lg p-0 m-2px my-8" style="background: var(--bg-secondary);" open>
          <summary class="cursor-pointer list-none flex items-center gap-2 text-2xl font-semibold mb-1 mt-1 p-1px hover:text-blue-600 transition-colors">
              <svg class="w-6 h-6 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            <span class="inline m-0 text-xl">üöÄ Used in Projects ({projectsUsingDevice.length})</span>
          </summary>
          <div class="px-6 py-4">
            {projectsUsingDevice.map(project => (
              <div class="flex justify-between items-center px-3 py-3 mb-2 last:mb-0 rounded-lg border" style="background: var(--bg-card); border-color: var(--border-card);">
                <a href={`/projects/${project.slug}`} class="text-link no-underline font-medium text-base hover:underline">
                  {project.data.title}
                </a>
                <span class={`status-badge status-badge-${project.data.status}`}>
                  {projectStatusLabels[project.data.status]}
                </span>
              </div>
            ))}
          </div>
        </details>
      )}

      {device.data.notes && (
        <div class="note-box">
          <h3 class="m-0 mb-2" style="color: var(--accent-amber);">üìù Notes</h3>
          <p class="m-0">{device.data.notes}</p>
        </div>
      )}

      {device.data.connectionTypes.length > 0 && (
        <div class="my-8">
          <h2 class="text-2xl font-semibold mt-6 mb-3 pb-2" style="border-bottom: 2px solid var(--border-primary);">Connection Types</h2>
          <div class="flex flex-wrap gap-2">
            {device.data.connectionTypes.map(conn => {
              const componentSlug = connectionTypeMap[conn.toLowerCase()];
              return componentSlug ? (
                <a href={`/components/${componentSlug}`} class="inline-block px-4 py-2 rounded text-base font-medium no-underline transition-all duration-200 hover:-translate-y-0.5" style="background: var(--bg-secondary); color: var(--text-primary); hover:background: var(--accent-blue); hover:color: white;">{conn}</a>
              ) : (
                <span class="inline-block px-4 py-2 rounded text-base font-medium" style="background: var(--bg-secondary); color: var(--text-primary);">{conn}</span>
              );
            })}
          </div>
        </div>
      )}

      {isInDisplayComparison && (
        <div class="my-8 p-6 rounded-lg border-2" style="background: var(--accent-blue-light); border-color: var(--accent-blue);">
          <div class="flex items-center gap-3">
            <svg class="w-6 h-6 shrink-0" style="color: var(--accent-blue);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path>
            </svg>
            <div class="flex-1">
              <h3 class="text-lg font-semibold m-0 mb-1" style="color: var(--accent-blue-dark);">üìê See This Display in Action</h3>
              <p class="m-0 text-sm" style="color: var(--text-primary);">
                This display is featured in our interactive size comparison.
              </p>
            </div>
            <a 
              href="/devices/all-displays" 
              class="px-4 py-2 rounded-lg font-semibold text-white no-underline transition-all hover:shadow-lg hover:-translate-y-0.5"
              style="background: var(--accent-blue);"
            >
              View Comparison üëÄ
            </a>
          </div>
        </div>
      )}

      <div id="_markdown_wrapper" class="my-8 prose max-w-none">
        <Content />
      </div>

      {device.data.references && device.data.references.length > 0 && (
        <div id="references" class="my-8">
          <h2 class="text-2xl font-semibold mt-6 mb-3 pb-2" style="border-bottom: 2px solid var(--border-primary);">References</h2>
          <ul class="list-none p-0">
            {device.data.references.map(ref => (
              <li class="mb-2">
                <a href={ref.url} target="_blank" rel="noopener noreferrer" class="text-link no-underline font-medium hover:underline">
                  {ref.title} <span><svg version="2.0" class="external-icon"><use href="#external-arrow"/></svg></span>
                </a>
              </li>
            ))}
          </ul>
        </div>
      )}

      {device.data.purchaseLinks && device.data.purchaseLinks.length > 0 && (
        <div id="where-to-buy" class="my-8">
          <h2 class="text-2xl font-semibold mt-6 mb-3 pb-2" style="border-bottom: 2px solid var(--border-primary);">Where to Buy</h2>
          <ul class="list-none p-0">
            {device.data.purchaseLinks.map(link => (
              <li class="mb-2">
                <a href={link.url} target="_blank" rel="noopener noreferrer" class="text-link no-underline font-medium hover:underline">
                  {link.vendor} <span><svg version="2.0" class="external-icon"><use href="#external-arrow"/></svg></span>
                </a>
              </li>
            ))}
          </ul>
        </div>
      )}

      <a href="/devices" class="inline-block mt-8 text-link no-underline font-medium hover:underline">‚Üê Back to all devices</a>

      <IssueReportButton 
        pageType="device"
        pageTitle={device.data.title}
        pageSlug={device.slug}
      />
    </article>

    {tocHeadings.length >= 3 && (
      <aside class="hidden lg:block">
        <div class="sticky top-8 max-h-[calc(100vh-4rem)] overflow-y-auto">
          <TableOfContents headings={tocHeadings} />
        </div>
      </aside>
    )}
  </div>

  <style>
    /* Details marker rotation for open state */
    details[open] summary::before {
      transform: rotate(90deg);
    }
  </style>
</Layout>
