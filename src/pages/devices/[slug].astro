---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import IssueReportButton from '../../components/IssueReportButton.astro';
import LastModified from '../../components/LastModified.astro';
import TableOfContents from '../../components/TableOfContents.astro';

export async function getStaticPaths() {
  const devices = await getCollection('devices');
  return devices.map(device => ({
    params: { slug: device.slug },
    props: { device },
  }));
}

const { device } = Astro.props;
const { Content, headings } = await device.render();

// Build complete ToC including conditional sections
const tocHeadings = [
  // Add "Page Info" link to top
  { depth: 2, slug: 'page-info', text: 'Page Info' },
  // Add markdown headings (H2-H4 only)
  ...headings.filter(h => h.depth >= 2 && h.depth <= 4),
];

// Add conditional sections to ToC if they exist in frontmatter
if (device.data.references && device.data.references.length > 0) {
  tocHeadings.push({ depth: 2, slug: 'references', text: 'References' });
}
if (device.data.purchaseLinks && device.data.purchaseLinks.length > 0) {
  tocHeadings.push({ depth: 2, slug: 'where-to-buy', text: 'Where to Buy' });
}

// Get projects using this device
const allProjects = await getCollection('projects');
const projectsUsingDevice = allProjects.filter(project => {
  const hasDevices = project.data.devices && Array.isArray(project.data.devices);
  if (!hasDevices) return false;
  
  // Case-insensitive comparison
  const deviceSlugLower = device.slug.toLowerCase();
  return project.data.devices.some(d => d.toLowerCase() === deviceSlugLower);
});

const statusLabels = {
  ready: 'ğŸ“¦ Ready',
  testing: 'ğŸ§ª Testing',
  deployed: 'âœ… Deployed',
  pending: 'ğŸ”¦ Pending',
  unsupported: 'â• Unsupported',
  retired: 'â¸ï¸ Retired',
};

const projectStatusLabels = {
  idea: 'ğŸ’­ Idea',
  'in-progress': 'ğŸ› ï¸ In Progress',
  completed: 'âœ… Completed',
  abandoned: 'â¸ï¸ Abandoned',
};

const productionStatusLabels = {
  active: 'âœ… Active',
  NRND: 'âš ï¸ Not Recommended for New Designs',
  discontinued: 'âŒ Discontinued',
  obsolete: 'âŒ Obsolete',
  unknown: 'â“ Unknown',
};

// Map connection types to component slugs
const connectionTypeMap: Record<string, string> = {
  'i2c': 'i2c',
  'spi': 'spi',
  'uart': 'uart',
  'gpio': 'gpio',
  'onewire': 'onewire',
  'analog': 'analog',
  'pwm': 'pwm',
  'built-in': 'builtin',
};

// Automatically determine device status based on project usage
let displayStatus = device.data.status;
if (projectsUsingDevice.length > 0) {
  // Only override if device is currently marked as 'ready'
  // This allows manual 'testing', 'deployed', or 'retired' status to be preserved
  if (device.data.status === 'ready') {
    // Check project statuses to determine device status
    const hasDeployedProject = projectsUsingDevice.some(p => p.data.status === 'completed');
    const hasInProgressProject = projectsUsingDevice.some(p => p.data.status === 'in-progress');
    
    if (hasDeployedProject) {
      displayStatus = 'deployed';
    } else if (hasInProgressProject) {
      displayStatus = 'testing';
    }
  }
}
---

<Layout title={`${device.data.title} - Devices`}>
  <div class="grid grid-cols-1 lg:grid-cols-[1fr_300px] gap-8 max-w-7xl mx-auto">
    {tocHeadings.length >= 3 && (
      <div class="lg:hidden mb-8">
        <TableOfContents headings={tocHeadings} />
      </div>
    )}
    
    <article class="min-w-0">
      <div id="page-info" class="flex justify-between items-center mb-4 flex-wrap gap-4">
        <h1 class="text-4xl font-semibold m-0">{device.data.title}</h1>
        <div class="flex gap-2 items-center flex-wrap">
          {device.data.productionStatus && device.data.productionStatus !== 'unknown' && (
            <span class={`inline-block text-sm px-3 py-2 rounded-lg font-medium ${
              device.data.productionStatus === 'active' ? 'bg-emerald-200 text-emerald-900' :
              device.data.productionStatus === 'NRND' ? 'bg-amber-100 text-amber-900' :
              'bg-red-100 text-red-900'
            }`}>
              {productionStatusLabels[device.data.productionStatus]}
            </span>
          )}
          <span class={`status-badge status-badge-${displayStatus}`}>
            {statusLabels[displayStatus]}
          </span>
        </div>
      </div>

      <div class="flex items-center gap-4 flex-wrap mb-8">
        <span class="inline-block bg-blue-600 text-white px-4 py-2 rounded-full text-sm font-semibold">{device.data.category}</span>
        {device.data.manufacturer && (
          <span class="text-gray-500 text-sm">{device.data.manufacturer}</span>
        )}
        {device.data.model && (
          <span class="text-gray-500 text-sm">Model: {device.data.model}</span>
        )}
        {device.data.variants && device.data.variants.length > 0 && (
          device.data.variants.map(variant => (
            <span class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-medium">{variant}</span>
          ))
        )}
        {device.data.dateAcquired && (
          <span class="text-gray-500 text-sm">ğŸ“… Acquired: {device.data.dateAcquired}</span>
        )}
      </div>

      <div class="bg-gray-100 p-6 rounded-lg mb-8">
        <p class="m-0 text-lg"><strong>{device.data.description}</strong></p>
      </div>

      <LastModified 
        date={device.data.lastModified}
        verified={device.data.lastVerified}
        showAge={true}
      />

      {projectsUsingDevice.length > 0 && (
        <details class="bg-gray-100 border-2 border-blue-600 rounded-lg p-0 my-8" open>
          <summary class="cursor-pointer px-6 py-4 select-none list-none bg-gradient-to-br from-blue-100 to-blue-50 rounded-lg transition-colors duration-200 hover:from-blue-200 hover:to-blue-100 [&::-webkit-details-marker]:hidden before:content-['â–¶'] before:inline-block before:mr-2 before:transition-transform before:duration-200 [[open]>&]:before:rotate-90">
            <h3 class="inline m-0 text-blue-800 text-xl">ğŸš€ Used in Projects ({projectsUsingDevice.length})</h3>
          </summary>
          <div class="px-6 py-4">
            {projectsUsingDevice.map(project => (
              <div class="flex justify-between items-center px-3 py-3 mb-2 last:mb-0 bg-white rounded-lg border border-gray-200">
                <a href={`/projects/${project.slug}`} class="text-blue-600 no-underline font-medium text-base hover:underline">
                  {project.data.title}
                </a>
                <span class={`status-badge status-badge-${project.data.status}`}>
                  {projectStatusLabels[project.data.status]}
                </span>
              </div>
            ))}
          </div>
        </details>
      )}

      {device.data.notes && (
        <div class="bg-amber-100 border-l-4 border-amber-500 px-6 py-6 rounded-lg my-8">
          <h3 class="m-0 mb-2 text-amber-900">ğŸ“ Notes</h3>
          <p class="m-0 text-amber-950">{device.data.notes}</p>
        </div>
      )}

      {device.data.connectionTypes.length > 0 && (
        <div class="my-8">
          <h2 class="text-2xl font-semibold mt-6 mb-3 border-b-2 border-gray-200 pb-2">Connection Types</h2>
          <div class="flex flex-wrap gap-2">
            {device.data.connectionTypes.map(conn => {
              const componentSlug = connectionTypeMap[conn.toLowerCase()];
              return componentSlug ? (
                <a href={`/components/${componentSlug}`} class="inline-block bg-gray-100 text-gray-800 px-4 py-2 rounded text-base font-medium no-underline transition-all duration-200 hover:bg-blue-600 hover:text-white hover:-translate-y-0.5">{conn}</a>
              ) : (
                <span class="inline-block bg-gray-100 text-gray-800 px-4 py-2 rounded text-base font-medium">{conn}</span>
              );
            })}
          </div>
        </div>
      )}

      <div class="my-8 prose max-w-none">
        <Content />
      </div>

      {device.data.references && device.data.references.length > 0 && (
        <div id="references" class="my-8">
          <h2 class="text-2xl font-semibold mt-6 mb-3 border-b-2 border-gray-200 pb-2">References</h2>
          <ul class="list-none p-0">
            {device.data.references.map(ref => (
              <li class="mb-2">
                <a href={ref.url} target="_blank" rel="noopener noreferrer" class="text-blue-600 no-underline font-medium hover:underline">
                  {ref.title} â†’
                </a>
              </li>
            ))}
          </ul>
        </div>
      )}

      {device.data.purchaseLinks && device.data.purchaseLinks.length > 0 && (
        <div id="where-to-buy" class="my-8">
          <h2 class="text-2xl font-semibold mt-6 mb-3 border-b-2 border-gray-200 pb-2">Where to Buy</h2>
          <ul class="list-none p-0">
            {device.data.purchaseLinks.map(link => (
              <li class="mb-2">
                <a href={link.url} target="_blank" rel="noopener noreferrer" class="text-blue-600 no-underline font-medium hover:underline">
                  {link.vendor} â†’
                </a>
              </li>
            ))}
          </ul>
        </div>
      )}

      <a href="/devices" class="inline-block mt-8 text-blue-600 no-underline font-medium hover:underline">â† Back to all devices</a>

      <IssueReportButton 
        pageType="device"
        pageTitle={device.data.title}
        pageSlug={device.slug}
      />
    </article>

    {tocHeadings.length >= 3 && (
      <aside class="hidden lg:block">
        <div class="sticky top-8 max-h-[calc(100vh-4rem)] overflow-y-auto">
          <TableOfContents headings={tocHeadings} />
        </div>
      </aside>
    )}
  </div>

  <style>
    /* Details marker rotation for open state */
    details[open] summary::before {
      transform: rotate(90deg);
    }
  </style>
</Layout>
