---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import DeviceCard from '../../components/DeviceCard.astro';
import displayComparisonImage from '../../content/devices/images/all_displays.jpg';
import boardComparisonImage from '../../content/devices/images/all_boards.jpg';

const devices = await getCollection('devices');
const allProjects = await getCollection('projects');

// Compute display status for each device based on project usage
const devicesWithStatus = devices.map(device => {
  const projectsUsingDevice = allProjects.filter(project => {
    const hasDevices = project.data.devices && Array.isArray(project.data.devices);
    if (!hasDevices) return false;
    
    const deviceSlugLower = device.slug.toLowerCase();
    return project.data.devices.some(d => d.toLowerCase() === deviceSlugLower);
  });

  let displayStatus: 'ready' | 'testing' | 'active' | 'deployed' | 'retired' | 'pending' | 'unsupported' = device.data.status;
  
  // Only override if device is currently marked as 'ready'
  if (projectsUsingDevice.length > 0 && device.data.status === 'ready') {
    const hasDeployedProject = projectsUsingDevice.some(p => p.data.status === 'completed');
    const hasInProgressProject = projectsUsingDevice.some(p => p.data.status === 'in-progress');
    
    if (hasDeployedProject) {
      displayStatus = 'deployed';
    } else if (hasInProgressProject) {
      displayStatus = 'active';
    }
  }

  return {
    ...device,
    displayStatus
  };
});

const categories = [...new Set(devices.map(d => d.data.category))].sort();
const statuses = [...new Set(devicesWithStatus.map(d => d.displayStatus))].sort();

// Collect all unique tags
const allTags = new Set<string>();
devices.forEach(d => {
  if (d.data.tags) {
    d.data.tags.forEach(tag => allTags.add(tag));
  }
});
const tags = [...allTags].sort();
---

<Layout title="Devices">
  <h1 class="text-4xl font-semibold mt-0 mb-6" style="color: var(--text-heading);">Devices</h1>
  <p class="text-lg mb-8" style="color: var(--text-secondary);">Physical hardware components for ESPHome projects</p>

  <!-- Filter Panel -->
  <details class="mb-8 p-6 rounded-lg" style="background: var(--bg-secondary); border: 1px solid var(--border-primary);">
    <summary class="flex justify-between items-center cursor-pointer list-none mb-0">
      <div class="flex items-center gap-4 flex-1">
        <h2 class="text-xl font-semibold m-0 flex items-center gap-2" style="color: var(--text-heading);">
          <svg class="w-5 h-5 transition-transform duration-200" style="transform: rotate(-90deg);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
          Filters
        </h2>
        <!-- Active Filters Pills (inline with heading) -->
        <div id="activePills" class="flex flex-wrap gap-2" style="display: none;"></div>
      </div>
    </summary>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
      <!-- Category Filter -->
      <div>
        <label class="block mb-3 font-medium text-sm" style="color: var(--text-primary);">Category</label>
        <div class="space-y-2 max-h-48 overflow-y-auto p-3 rounded" style="background: var(--bg-card); border: 1px solid var(--border-card);">
          {categories.map(cat => (
            <label class="flex items-center gap-2 cursor-pointer hover:bg-opacity-50 p-1 rounded transition-colors" style="color: var(--text-primary);">
              <input 
                type="checkbox" 
                name="category" 
                value={cat}
                class="filter-checkbox w-4 h-4 rounded cursor-pointer"
                style="accent-color: var(--accent-blue);"
              />
              <span class="text-sm">{cat}</span>
            </label>
          ))}
        </div>
      </div>

      <!-- Status Filter -->
      <div>
        <label class="block mb-3 font-medium text-sm" style="color: var(--text-primary);">Status</label>
        <div class="space-y-2 max-h-48 overflow-y-auto p-3 rounded" style="background: var(--bg-card); border: 1px solid var(--border-card);">
          {statuses.map(status => (
            <label class="flex items-center gap-2 cursor-pointer hover:bg-opacity-50 p-1 rounded transition-colors" style="color: var(--text-primary);">
              <input 
                type="checkbox" 
                name="status" 
                value={status}
                class="filter-checkbox w-4 h-4 rounded cursor-pointer"
                style="accent-color: var(--accent-blue);"
              />
              <span class="text-sm capitalize">{status}</span>
            </label>
          ))}
        </div>
      </div>

      <!-- Tags Filter -->
      <div>
        <label class="block mb-3 font-medium text-sm" style="color: var(--text-primary);">Tags</label>
        <!-- Tag Search -->
        <input 
          type="text" 
          id="tagSearch" 
          placeholder="Search tags..."
          class="w-full px-3 py-2 mb-1 rounded text-sm"
          style="background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-card);"
        />
        <div class="space-y-2 max-h-38 overflow-y-auto p-3 rounded" style="background: var(--bg-card); border: 1px solid var(--border-card);">
          {tags.map(tag => (
            <label class="tag-checkbox-label flex items-center gap-2 cursor-pointer hover:bg-opacity-50 p-1 rounded transition-colors" style="color: var(--text-primary);" data-tag={tag.toLowerCase()}>
              <input 
                type="checkbox" 
                name="tag" 
                value={tag}
                class="filter-checkbox w-4 h-4 rounded cursor-pointer"
                style="accent-color: var(--accent-blue);"
              />
              <span class="text-sm">{tag}</span>
            </label>
          ))}
        </div>
      </div>
    </div>

    <!-- Results Counter -->
    <div class="mt-4 pt-4" style="border-top: 1px solid var(--border-primary);">
      <p class="text-sm m-0" style="color: var(--text-secondary);">
        <span>Showing <span id="resultCount" class="font-semibold" style="color: var(--text-primary);">0</span> devices</span>
        <button id="clearFilters" class="ml-4 px-4 py-2 rounded text-sm font-medium transition-colors" style="background: var(--bg-card); color: var(--text-secondary); border: 1px solid var(--border-card);" onmouseover="this.style.borderColor='var(--accent-blue)'; this.style.color='var(--accent-blue)';" onmouseout="this.style.borderColor='var(--border-card)'; this.style.color='var(--text-secondary)';" onclick="event.stopPropagation();">
        Clear All
      </button>
      </p>
    </div>
  </details>

  <!-- Comparison Links -->
  <div class="inline-flex mb-8 gap-2">
    <!-- Display Comparison -->
    <div>
      <!-- Simple link (always visible) -->
      <a 
        href="/devices/all-displays" 
        id="simpleDisplayComparisonLink"
        class="inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium no-underline transition-all hover:shadow-md"
        style="background: var(--bg-secondary); color: var(--text-link); border: 1px solid var(--border-primary);"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path>
        </svg>
        Compare Display Sizes
      </a>
      
      <!-- Enhanced link with thumbnail (shown when display category is filtered) -->
      <a 
        href="/devices/all-displays" 
        id="enhancedDisplayComparisonLink"
        class="hidden p-6 rounded-lg border-2 no-underline transition-all hover:shadow-xl hover:-translate-y-1"
        style="background: var(--accent-blue-light); border-color: var(--accent-blue); display: none;"
      >
        <div class="flex gap-6 items-center">
          <img 
            src={displayComparisonImage.src} 
            alt="Display size comparison preview"
            class="w-48 h-32 object-cover rounded-lg border"
            style="border-color: var(--border-primary);"
          />
          <div class="flex-1">
            <h3 class="text-xl font-bold m-0 mb-2" style="color: var(--accent-blue-dark);">
              üìê Compare Display Sizes
            </h3>
            <p class="m-0" style="color: var(--text-primary);">
              See an interactive comparison of all displays showing their relative sizes and specifications.
            </p>
          </div>
          <svg class="w-6 h-6 shrink-0" style="color: var(--accent-blue);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </div>
      </a>
    </div>

    <!-- Board Comparison -->
    <div>
      <!-- Simple link (always visible) -->
      <a 
        href="/devices/all-boards" 
        id="simpleBoardComparisonLink"
        class="inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium no-underline transition-all hover:shadow-md"
        style="background: var(--bg-secondary); color: var(--text-link); border: 1px solid var(--border-primary);"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
        </svg>
        Compare Board Sizes
      </a>
      
      <!-- Enhanced link with thumbnail (shown when board category is filtered) -->
      <a 
        href="/devices/all-boards" 
        id="enhancedBoardComparisonLink"
        class="hidden p-6 rounded-lg border-2 no-underline transition-all hover:shadow-xl hover:-translate-y-1"
        style="background: var(--accent-emerald-light); border-color: var(--accent-emerald); display: none;"
      >
        <div class="flex gap-6 items-center">
          <img 
            src={boardComparisonImage.src} 
            alt="Board size comparison preview"
            class="w-48 h-32 object-cover rounded-lg border"
            style="border-color: var(--border-primary);"
          />
          <div class="flex-1">
            <h3 class="text-xl font-bold m-0 mb-2" style="color: var(--accent-emerald-dark);">
              üî≤ Compare Board Sizes
            </h3>
            <p class="m-0" style="color: var(--text-primary);">
              See an interactive comparison of all development boards showing their relative sizes and specifications.
            </p>
          </div>
          <svg class="w-6 h-6 shrink-0" style="color: var(--accent-emerald);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </div>
      </a>
    </div>
  </div>

  <div class="grid grid-cols-[repeat(auto-fill,minmax(300px,1fr))] gap-6" id="deviceGrid">
    {devicesWithStatus.map(device => (
      <div 
        data-category={device.data.category}
        data-status={device.displayStatus}
        data-tags={device.data.tags ? device.data.tags.join(',') : ''}
      >
        <DeviceCard device={device} />
      </div>
    ))}
  </div>

  <script>
    import { updateFilterPills, initFilterDetailsArrow } from '../../utils/filterPills';

    const clearButton = document.getElementById('clearFilters') as HTMLButtonElement;
    const tagSearchInput = document.getElementById('tagSearch') as HTMLInputElement;
    const grid = document.getElementById('deviceGrid');
    const resultCount = document.getElementById('resultCount');
    const simpleDisplayComparisonLink = document.getElementById('simpleDisplayComparisonLink') as HTMLElement;
    const enhancedDisplayComparisonLink = document.getElementById('enhancedDisplayComparisonLink') as HTMLElement;
    const simpleBoardComparisonLink = document.getElementById('simpleBoardComparisonLink') as HTMLElement;
    const enhancedBoardComparisonLink = document.getElementById('enhancedBoardComparisonLink') as HTMLElement;

    // Initialize filter panel arrow rotation
    initFilterDetailsArrow();

    function updateActivePills() {
      updateFilterPills({
        pillsContainerId: 'activePills',
        filters: [
          { name: 'category', selector: 'input[name="category"]:checked', color: 'var(--accent-blue-light)' },
          { name: 'status', selector: 'input[name="status"]:checked', color: 'var(--accent-emerald-light)' },
          { name: 'tag', selector: 'input[name="tag"]:checked', color: 'var(--accent-amber-light)' }
        ],
        onRemove: applyFilters
      });
    }
    
    function updateComparisonLinks() {
      // Check if 'display' category is selected
      const displayCategorySelected = Array.from(document.querySelectorAll('input[name="category"]:checked'))
        .some(cb => (cb as HTMLInputElement).value.toLowerCase() === 'display');
      
      if (displayCategorySelected) {
        // Show enhanced display link with thumbnail
        simpleDisplayComparisonLink.style.display = 'none';
        enhancedDisplayComparisonLink.style.display = 'flex';
      } else {
        // Show simple display link
        simpleDisplayComparisonLink.style.display = 'inline-flex';
        enhancedDisplayComparisonLink.style.display = 'none';
      }
      
      // Check if 'board' category is selected
      const boardCategorySelected = Array.from(document.querySelectorAll('input[name="category"]:checked'))
        .some(cb => (cb as HTMLInputElement).value.toLowerCase() === 'board');
      
      if (boardCategorySelected) {
        // Show enhanced board link with thumbnail
        simpleBoardComparisonLink.style.display = 'none';
        enhancedBoardComparisonLink.style.display = 'flex';
      } else {
        // Show simple board link
        simpleBoardComparisonLink.style.display = 'inline-flex';
        enhancedBoardComparisonLink.style.display = 'none';
      }
    }

    function applyFilters() {
      // Get all checked checkboxes
      const selectedCategories = Array.from(document.querySelectorAll('input[name="category"]:checked'))
        .map(cb => (cb as HTMLInputElement).value.toLowerCase());
      const selectedStatuses = Array.from(document.querySelectorAll('input[name="status"]:checked'))
        .map(cb => (cb as HTMLInputElement).value.toLowerCase());
      const selectedTags = Array.from(document.querySelectorAll('input[name="tag"]:checked'))
        .map(cb => (cb as HTMLInputElement).value.toLowerCase());
      
      const cards = grid?.querySelectorAll('[data-category]');
      let visibleCount = 0;
      
      cards?.forEach(card => {
        const category = card.getAttribute('data-category')?.toLowerCase() || '';
        const status = card.getAttribute('data-status')?.toLowerCase() || '';
        const tags = card.getAttribute('data-tags')?.toLowerCase().split(',').filter(t => t) || [];
        
        // If no filters selected in a category, show all for that category
        const categoryMatch = selectedCategories.length === 0 || selectedCategories.includes(category);
        const statusMatch = selectedStatuses.length === 0 || selectedStatuses.includes(status);
        const tagMatch = selectedTags.length === 0 || selectedTags.some(tag => tags.includes(tag));
        
        if (categoryMatch && statusMatch && tagMatch) {
          (card as HTMLElement).style.display = 'block';
          visibleCount++;
        } else {
          (card as HTMLElement).style.display = 'none';
        }
      });

      if (resultCount) {
        resultCount.textContent = visibleCount.toString();
      }
      
      updateActivePills();
      updateComparisonLinks();
    }

    function filterTagList() {
      const searchTerm = tagSearchInput.value.toLowerCase();
      const tagLabels = document.querySelectorAll('.tag-checkbox-label');
      
      tagLabels.forEach(label => {
        const tagName = label.getAttribute('data-tag') || '';
        if (tagName.includes(searchTerm)) {
          (label as HTMLElement).style.display = 'flex';
        } else {
          (label as HTMLElement).style.display = 'none';
        }
      });
    }

    function clearFilters() {
      // Uncheck all checkboxes
      document.querySelectorAll('.filter-checkbox').forEach(cb => {
        (cb as HTMLInputElement).checked = false;
      });
      // Clear tag search
      if (tagSearchInput) {
        tagSearchInput.value = '';
        filterTagList();
      }
      applyFilters();
    }

    // Event listeners for all checkboxes
    document.querySelectorAll('.filter-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', applyFilters);
    });

    // Event listener for tag search
    tagSearchInput?.addEventListener('input', filterTagList);

    clearButton?.addEventListener('click', clearFilters);

    // Initial count
    applyFilters();
  </script>
</Layout>
