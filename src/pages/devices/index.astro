---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import DeviceCard from '../../components/DeviceCard.astro';

const devices = await getCollection('devices');
const allProjects = await getCollection('projects');

// Compute display status for each device based on project usage
const devicesWithStatus = devices.map(device => {
  const projectsUsingDevice = allProjects.filter(project => {
    const hasDevices = project.data.devices && Array.isArray(project.data.devices);
    if (!hasDevices) return false;
    
    const deviceSlugLower = device.slug.toLowerCase();
    return project.data.devices.some(d => d.toLowerCase() === deviceSlugLower);
  });

  let displayStatus = device.data.status;
  
  // Only override if device is currently marked as 'ready'
  if (projectsUsingDevice.length > 0 && device.data.status === 'ready') {
    const hasDeployedProject = projectsUsingDevice.some(p => p.data.status === 'completed');
    const hasInProgressProject = projectsUsingDevice.some(p => p.data.status === 'in-progress');
    
    if (hasDeployedProject) {
      displayStatus = 'deployed';
    } else if (hasInProgressProject) {
      displayStatus = 'testing';
    }
  }

  return {
    ...device,
    displayStatus
  };
});

const categories = [...new Set(devices.map(d => d.data.category))].sort();
const statuses = [...new Set(devicesWithStatus.map(d => d.displayStatus))].sort();

// Collect all unique tags
const allTags = new Set<string>();
devices.forEach(d => {
  if (d.data.tags) {
    d.data.tags.forEach(tag => allTags.add(tag));
  }
});
const tags = [...allTags].sort();
---

<Layout title="Devices">
  <h1 class="text-4xl font-semibold mt-0 mb-6" style="color: var(--text-heading);">Devices</h1>
  <p class="text-lg mb-8" style="color: var(--text-secondary);">Physical hardware components for ESPHome projects</p>

  <!-- Filter Panel -->
  <details class="mb-8 p-6 rounded-lg" style="background: var(--bg-secondary); border: 1px solid var(--border-primary);">
    <summary class="flex justify-between items-center cursor-pointer list-none mb-0">
      <h2 class="text-xl font-semibold m-0 flex items-center gap-2" style="color: var(--text-heading);">
        <svg class="w-5 h-5 transition-transform duration-200" style="transform: rotate(-90deg);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
        Filters
      </h2>
      <button id="clearFilters" class="px-4 py-2 rounded text-sm font-medium transition-colors" style="background: var(--bg-card); color: var(--text-secondary); border: 1px solid var(--border-card);" onmouseover="this.style.borderColor='var(--accent-blue)'; this.style.color='var(--accent-blue)';" onmouseout="this.style.borderColor='var(--border-card)'; this.style.color='var(--text-secondary)';" onclick="event.stopPropagation();">
        Clear All
      </button>
    </summary>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
      <!-- Category Filter -->
      <div>
        <label class="block mb-3 font-medium text-sm" style="color: var(--text-primary);">Category</label>
        <div class="space-y-2 max-h-48 overflow-y-auto p-3 rounded" style="background: var(--bg-card); border: 1px solid var(--border-card);">
          {categories.map(cat => (
            <label class="flex items-center gap-2 cursor-pointer hover:bg-opacity-50 p-1 rounded transition-colors" style="color: var(--text-primary);">
              <input 
                type="checkbox" 
                name="category" 
                value={cat}
                class="filter-checkbox w-4 h-4 rounded cursor-pointer"
                style="accent-color: var(--accent-blue);"
              />
              <span class="text-sm">{cat}</span>
            </label>
          ))}
        </div>
      </div>

      <!-- Status Filter -->
      <div>
        <label class="block mb-3 font-medium text-sm" style="color: var(--text-primary);">Status</label>
        <div class="space-y-2 max-h-48 overflow-y-auto p-3 rounded" style="background: var(--bg-card); border: 1px solid var(--border-card);">
          {statuses.map(status => (
            <label class="flex items-center gap-2 cursor-pointer hover:bg-opacity-50 p-1 rounded transition-colors" style="color: var(--text-primary);">
              <input 
                type="checkbox" 
                name="status" 
                value={status}
                class="filter-checkbox w-4 h-4 rounded cursor-pointer"
                style="accent-color: var(--accent-blue);"
              />
              <span class="text-sm capitalize">{status}</span>
            </label>
          ))}
        </div>
      </div>

      <!-- Tags Filter -->
      <div>
        <label class="block mb-3 font-medium text-sm" style="color: var(--text-primary);">Tags</label>
        <!-- Tag Search -->
        <input 
          type="text" 
          id="tagSearch" 
          placeholder="Search tags..."
          class="w-full px-3 py-2 mb-1 rounded text-sm"
          style="background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-card);"
        />
        <div class="space-y-2 max-h-38 overflow-y-auto p-3 rounded" style="background: var(--bg-card); border: 1px solid var(--border-card);">
          {tags.map(tag => (
            <label class="tag-checkbox-label flex items-center gap-2 cursor-pointer hover:bg-opacity-50 p-1 rounded transition-colors" style="color: var(--text-primary);" data-tag={tag.toLowerCase()}>
              <input 
                type="checkbox" 
                name="tag" 
                value={tag}
                class="filter-checkbox w-4 h-4 rounded cursor-pointer"
                style="accent-color: var(--accent-blue);"
              />
              <span class="text-sm">{tag}</span>
            </label>
          ))}
        </div>
      </div>
    </div>

    <!-- Results Counter -->
    <div class="mt-4 pt-4" style="border-top: 1px solid var(--border-primary);">
      <p class="text-sm m-0" style="color: var(--text-secondary);">
        Showing <span id="resultCount" class="font-semibold" style="color: var(--text-primary);">0</span> devices
      </p>
    </div>
  </details>

  <div class="grid grid-cols-[repeat(auto-fill,minmax(300px,1fr))] gap-6" id="deviceGrid">
    {devicesWithStatus.map(device => (
      <div 
        data-category={device.data.category}
        data-status={device.displayStatus}
        data-tags={device.data.tags ? device.data.tags.join(',') : ''}
      >
        <DeviceCard device={device} />
      </div>
    ))}
  </div>

  <script>
    const clearButton = document.getElementById('clearFilters') as HTMLButtonElement;
    const tagSearchInput = document.getElementById('tagSearch') as HTMLInputElement;
    const grid = document.getElementById('deviceGrid');
    const resultCount = document.getElementById('resultCount');
    const filterDetails = document.querySelector('details') as HTMLDetailsElement;

    // Rotate arrow on toggle
    filterDetails?.addEventListener('toggle', () => {
      const arrow = filterDetails.querySelector('svg');
      if (arrow) {
        arrow.style.transform = filterDetails.open ? 'rotate(0deg)' : 'rotate(-90deg)';
      }
    });

    function applyFilters() {
      // Get all checked checkboxes
      const selectedCategories = Array.from(document.querySelectorAll('input[name="category"]:checked'))
        .map(cb => (cb as HTMLInputElement).value.toLowerCase());
      const selectedStatuses = Array.from(document.querySelectorAll('input[name="status"]:checked'))
        .map(cb => (cb as HTMLInputElement).value.toLowerCase());
      const selectedTags = Array.from(document.querySelectorAll('input[name="tag"]:checked'))
        .map(cb => (cb as HTMLInputElement).value.toLowerCase());
      
      const cards = grid?.querySelectorAll('[data-category]');
      let visibleCount = 0;
      
      cards?.forEach(card => {
        const category = card.getAttribute('data-category')?.toLowerCase() || '';
        const status = card.getAttribute('data-status')?.toLowerCase() || '';
        const tags = card.getAttribute('data-tags')?.toLowerCase().split(',').filter(t => t) || [];
        
        // If no filters selected in a category, show all for that category
        const categoryMatch = selectedCategories.length === 0 || selectedCategories.includes(category);
        const statusMatch = selectedStatuses.length === 0 || selectedStatuses.includes(status);
        const tagMatch = selectedTags.length === 0 || selectedTags.some(tag => tags.includes(tag));
        
        if (categoryMatch && statusMatch && tagMatch) {
          (card as HTMLElement).style.display = 'block';
          visibleCount++;
        } else {
          (card as HTMLElement).style.display = 'none';
        }
      });

      if (resultCount) {
        resultCount.textContent = visibleCount.toString();
      }
    }

    function filterTagList() {
      const searchTerm = tagSearchInput.value.toLowerCase();
      const tagLabels = document.querySelectorAll('.tag-checkbox-label');
      
      tagLabels.forEach(label => {
        const tagName = label.getAttribute('data-tag') || '';
        if (tagName.includes(searchTerm)) {
          (label as HTMLElement).style.display = 'flex';
        } else {
          (label as HTMLElement).style.display = 'none';
        }
      });
    }

    function clearFilters() {
      // Uncheck all checkboxes
      document.querySelectorAll('.filter-checkbox').forEach(cb => {
        (cb as HTMLInputElement).checked = false;
      });
      // Clear tag search
      if (tagSearchInput) {
        tagSearchInput.value = '';
        filterTagList();
      }
      applyFilters();
    }

    // Event listeners for all checkboxes
    document.querySelectorAll('.filter-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', applyFilters);
    });

    // Event listener for tag search
    tagSearchInput?.addEventListener('input', filterTagList);

    clearButton?.addEventListener('click', clearFilters);

    // Initial count
    applyFilters();
  </script>
</Layout>
