---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import ProjectCard from '../../components/ProjectCard.astro';
import FilterPanel from '../../components/FilterPanel.astro';

const projects = await getCollection('projects');

// Collect all unique tags
const allTags = new Set<string>();
projects.forEach(p => {
  if (p.data.tags) {
    p.data.tags.forEach(tag => allTags.add(tag));
  }
});
const tags = [...allTags].sort();

// Calculate age category for each project based on lastModified
const now = new Date();
const projectsWithAge = projects.map(project => {
  let age = 'unknown';
  if (project.data.lastModified) {
    const lastUpdate = new Date(project.data.lastModified);
    const daysDiff = Math.floor((now.getTime() - lastUpdate.getTime()) / (1000 * 60 * 60 * 24));
    if (daysDiff <= 30) age = '30days';
    else if (daysDiff <= 90) age = '90days';
    else if (daysDiff <= 365) age = '1year';
    else age = 'older';
  }
  return { ...project, age };
});

// Define age filter options
const ageFilters = [
  { value: '30days', label: 'Recently updated' },
  { value: '90days', label: 'Updated 1-3 months ago' },
  { value: '1year', label: 'Updated 3-12 months ago' },
  { value: 'older', label: 'Not updated in over a year' },
];

// Combine age filters first (in order), then tags alphabetically
const filters = [
  ...ageFilters.map(af => ({ type: 'age', value: af.value, label: af.label })),
  ...tags.map(tag => ({ type: 'tag', value: tag, label: tag }))
];
---

<Layout title="Projects">
  <h1 class="text-4xl font-semibold mt-0 mb-6" style="color: var(--text-heading);">Projects</h1>
  <p class="text-lg mb-8" style="color: var(--text-secondary);">Complete projects with wiring and configuration</p>

  <FilterPanel 
    filters={filters}
    itemName="projects"
    searchPlaceholder="Search tags and timeframes..."
    getBadgeLabel={(type) => type === 'tag' ? 'tag' : 'updated'}
  />

  <div class="grid grid-cols-[repeat(auto-fill,minmax(320px,1fr))] gap-6" id="projectGrid">
    {projectsWithAge.map(project => (
      <div 
        data-tags={project.data.tags ? project.data.tags.join(',') : ''}
        data-age={project.age}
      >
        <ProjectCard project={project} />
      </div>
    ))}
  </div>

  <script>
    import { initializeFilters } from '../../utils/filterPills';

    initializeFilters({
      gridSelector: 'projectGrid',
      resultCountId: 'resultCount',
      clearButtonId: 'clearFilters',
      searchInputId: 'filterSearch',
      pillsContainerId: 'activePills',
      filters: [
        {
          name: 'tag',
          selector: 'input[name="filter"][data-type="tag"]:checked',
          attribute: { name: 'tags', isArray: true },
          color: 'var(--accent-amber-light)'
        },
        {
          name: 'age',
          selector: 'input[name="filter"][data-type="age"]:checked',
          attribute: { name: 'age', isArray: false },
          color: 'var(--accent-blue-light)'
        }
      ]
    });
  </script>
</Layout>
